!function(){"use strict";frappe.templates.print_layout='<div class="form-print-wrapper">  <div class="print-toolbar row">   <div class="col-xs-2">    <select class="print-preview-select input-sm form-control"></select></div>   <div class="col-xs-2">    <select class="languages input-sm form-control"     placeholder="{{ __("Language") }}"></select></div>   <div class="col-xs-2">    <div class="checkbox small" style="margin-top: 7px; margin-bottom: 0px;">                 <label>                     <input type="checkbox" class="print-letterhead text-muted" style="margin-top: 1px;"/>                     {%= __("Letter Head") %}</label>             </div>         </div>   <div class="col-xs-6 text-right">                          <div class="btn-group">                 <a class="btn-print-print btn-sm btn btn-default">                     <strong>{%= __("Print") %}</strong></a>        <a class="btn-sm btn btn-default" href="#Form/Print Settings">                     {%= __("Settings...") %}</a>        <a class="btn-print-edit btn-sm btn btn-default">                     {%= __("Customize...") %}</a>        <a class="btn-print-preview btn-sm btn btn-default">                     {%= __("Full Page") %}</a>        <a class="btn-download-pdf btn-sm btn btn-default">                     {%= __("PDF") %}</a>             </div>   </div>  </div>  <div class="print-preview-wrapper">         <div class="print-preview">       <div class="print-format"></div>   </div>   <div class="page-break-message text-muted text-center text-medium margin-top"></div>     </div> </div> ',frappe.templates.users_in_sidebar='{% for (var i=0, l=users.length; i < l; i++) {  var u = users[i]; %}  <span class="avatar avatar-small {{ u.avatar_class || "" }}" title="{{ u.title }}">  {% if (u.icon) { %}   <i class="{{ u.icon }}"></i>  {% } else if(u.image) { %}   <img class="media-object" src="{{ u.image }}" alt="{{ u.fullname }}">  {% } else { %}   <div class="standard-image" style="background-color: {{ u.color }};">{{ u.abbr.substr(0,1) }}</div>  {% } %}  </span> {% } %} ',frappe.templates.set_sharing='<div class="padding">      <div class="row">         <div class="col-xs-6"><h6>{%= __("User") %}</h6></div>         <div class="col-xs-2"><h6>{%= __("Can Read") %}</h6></div>         <div class="col-xs-2"><h6>{%= __("Can Write") %}</h6></div>         <div class="col-xs-2"><h6>{%= __("Can Share") %}</h6></div>     </div>   <div class="row shared-user" data-everyone=1>         <div class="col-xs-6 share-all" style="height: 30px;"><b>{{ __("Everyone") }}</b></div>         <div class="col-xs-2"><input type="checkbox" name="read"             {% if(cint(everyone.read)) { %}checked{% } %} class="edit-share"></div>         <div class="col-xs-2"><input type="checkbox" name="write"             {% if(cint(everyone.write)) { %}checked{% } %} class="edit-share"{% if (!frm.perm[0].write){ %} disabled="disabled"{% } %}></div>         <div class="col-xs-2"><input type="checkbox" name="share"             {% if(cint(everyone.share)) { %}checked{% } %} class="edit-share"></div>  </div>      {% for (var i=0, l=shared.length; i < l; i++) {         var s = shared[i]; %}      {% if(s && !s.everyone) { %}      <div class="row shared-user" data-user="{%= s.user %}" data-name="{%= s.name %}">          <div class="col-xs-6">{%= s.user %}</div>          <div class="col-xs-2"><input type="checkbox" name="read"              {% if(cint(s.read)) { %}checked{% } %} class="edit-share"></div>          <div class="col-xs-2"><input type="checkbox" name="write"              {% if(cint(s.write)) { %}checked{% } %} class="edit-share"{% if (!frm.perm[0].write){ %} disabled="disabled"{% } %}></div>          <div class="col-xs-2"><input type="checkbox" name="share"              {% if(cint(s.share)) { %}checked{% } %} class="edit-share"></div>      </div>      {% } %}     {% } %}      {% if(frappe.model.can_share(null, frm)) { %}     <hr>      <div class="row">         <div class="col-xs-6"><h6>{%= __("Share this document with") %}</h6></div>         <div class="col-xs-2"><h6>{%= __("Can Read") %}</h6></div>         <div class="col-xs-2"><h6>{%= __("Can Write") %}</h6></div>         <div class="col-xs-2"><h6>{%= __("Can Share") %}</h6></div>     </div>      <div class="row">         <div class="col-xs-6 input-wrapper-add-share"></div>         <div class="col-xs-2"><input type="checkbox" class="add-share-read" name="read"></div>         <div class="col-xs-2"><input type="checkbox" class="add-share-write" name="write" {% if (!frm.perm[0].write){ %} disabled="disabled"{% } %}></div>         <div class="col-xs-2"><input type="checkbox" class="add-share-share" name="share"></div>     </div>     <p>         <button class="btn btn-primary btn-add-share">{{ __("Add") }}</button>     </p>     <div class="row">   <div class="col-xs-6"></div>   <div class="col-xs-6">   <div class="checkbox">    <label><span class="input-area">     <input type="checkbox" class="add-share-notify"      name="notify"></span>     <span class="label-area small">{{ __("Notify by email") }}</span>    </label>   </div>   </div>  </div>  {% endif %} </div>',frappe.templates.form_sidebar='<ul class="list-unstyled sidebar-menu user-actions hidden"></ul> <ul class="list-unstyled sidebar-menu sidebar-image-section hidden-xs hidden-sm hide">  <li class="divider"></li>  <li class="sidebar-image-wrapper">   <div class="sidebar-image"></div>   <div class="sidebar-standard-image">    <div class="standard-image"></div>   </div>  </li> </ul> {% if frm.meta.beta %} <div class="sidebar-menu">  <p><label class="label label-warning" title="{{ __("This feature is brand new and still experimental") }}">{{ __("Under Development") }}</label></p>  <p><a class="small" href="https://github.com/frappe/{{ frappe.boot.module_app[frappe.scrub(frm.meta.module)] }}/issues/new"    target="_blank">   {{ __("Click here to post bugs and suggestions") }}</a></p>  </div> {% endif %} <ul class="list-unstyled sidebar-menu sidebar-rating hide">  <li class="divider"></li>  <li style="position: relative;">   <a class="strong badge-hover">    <span>{%= __("Feedback") %}</span>   </a>  </li>  <li class="rating-icons"></li> </ul> <ul class="list-unstyled sidebar-menu">  <li class="divider"></li>  <li style="position: relative;">   <a class="strong sidebar-comments badge-hover">    <span>{%= __("Comments") %}</span>    <span class="badge n-comments">0</span>   </a>  </li>     {% if(frappe.help.has_help(doctype)) { %}     <li><a class="strong help-link" data-doctype="{{ doctype }}">{{ __("Help") }}</a></li>     {% } %} </ul> <ul class="list-unstyled sidebar-menu form-assignments">  <li class="divider"></li>  <li class="h6 assigned-to-label">{%= __("Assigned To") %}</li>  <li><a class="strong add-assignment">{%= __("Assign") %}   <i class="octicon octicon-plus" style="margin-left: 2px;"></i></a></li> </ul> <ul class="list-unstyled sidebar-menu form-attachments">  <li class="divider"></li>  <li class="h6 attachments-label">{%= __("Attachments") %}</li>  <li><a class="strong add-attachment">{%= __("Attach File") %}   <i class="octicon octicon-plus" style="margin-left: 2px;"></i></li></a> </ul> <ul class="list-unstyled sidebar-menu">  <li class="divider"></li>  <li class="h6 tags-label">{%= __("Tags") %}</li>  <li class="form-tags">   <div class="tag-area"></div>   <div class="clearfix"></div>  </li> </ul> <ul class="list-unstyled sidebar-menu">  <li class="divider"></li>  <li class="h6 shared-with-label">{%= __("Shared With") %}</li>  <li class="form-shared"></li> </ul> <ul class="list-unstyled sidebar-menu">  <li class="divider"></li>  <li class="h6 viewers-label">{%= __("Currently Viewing") %}</li>  <li class="form-viewers"></li> </ul> <ul class="list-unstyled sidebar-menu text-muted">  <li class="liked-by-parent">   <span class="liked-by">    <i class="octicon octicon-heart like-action text-extra-muted fa-fw"></i>    <span class="likes-count"></span>   </span>  </li>  <li class="modified-by"></li>  <li class="created-by"></li> </ul> {% if(frappe.get_form_sidebar_extension) { %}     {{ frappe.get_form_sidebar_extension() }} {% } %} <ul class="list-unstyled visible-xs visible-sm">  <li class="divider"></li>  <li class="close-sidebar">Close</li> </ul>',frappe.templates.form_dashboard='<div class="form-dashboard-wrapper">  <div class="progress-area hidden form-dashboard-section">  </div>  <div class="form-heatmap hidden form-dashboard-section">   <div id="heatmap-{{ frappe.model.scrub(frm.doctype) }}" class="heatmap"></div>   <div class="text-muted small heatmap-message hidden"></div>  </div>  <div class="form-graph form-dashboard-section hidden"></div>  <div class="form-stats form-dashboard-section hidden">   <div class="row"></div>  </div>  <div class="form-links form-dashboard-section hidden">   <div class="transactions"></div>  </div> </div>',frappe.templates.form_document_flow='<div class="document-flow">  {% for dt in doctypes %}  <span class="document-flow-link-wrapper">   <a data-doctype="{{ dt }}"    class="document-flow-link {% if (dt===frm.doctype) { %} strong disabled {% } %} "    style="color: inherit;">    <span class="indicator {% if (dt===frm.doctype) { %} blue {% } else { %} darkgrey {% } %}"></span><br>    <span class="document-flow-link-label">{{ __(dt) }}</span>   </a>  </span>  {% endfor %} </div> ',frappe.templates.form_links='<div class="form-documents">  {% for (var i=0; i < transactions.length; i++) { %}   {% if((i % 2)===0) { %}<div class="row">{% } %}   <div class="col-xs-6">    <h6>{{ transactions[i].label }}</h6>    {% for (var j=0; j < transactions[i].items.length; j++) {     var doctype = transactions[i].items[j]; %}    <div class="document-link"     data-doctype="{{ doctype }}">     <a class="badge-link small">{{ __(doctype) }}</a>     <span class="text-muted small count"></span>     <span class="open-notification hidden"      title="{{ __("Open {0}", [__(doctype)])}}"></span>     {% if !internal_links[doctype] %}      <button class="btn btn-new btn-default btn-xs hidden"       data-doctype="{{ doctype }}">        <i class="octicon octicon-plus" style="font-size: 12px;"></i></button>     {% endif %}    </div>    {% } %}   </div>   {% if((i % 2)===1) { %}</div>{% } %}  {% } %}    {% if((i % 2)===0) { %}</div>{% } %} </div> ',frappe.provide("frappe.views.formview"),frappe.views.FormFactory=class extends frappe.views.Factory{make(e){var t=this,i=e[1];frappe.views.formview[i]?t.show_doc(e):frappe.model.with_doctype(i,function(){t.page=frappe.container.add_page("Form/"+i),frappe.views.formview[i]=t.page,t.page.frm=new _f.Frm(i,t.page,!0),t.show_doc(e)}),this.initialized||($(document).on("page-change",function(){frappe.ui.form.close_grid_form()}),frappe.realtime.on("new_communication",function(e){frappe.timeline.new_communication(e)}),frappe.realtime.on("delete_communication",function(e){frappe.timeline.delete_communication(e)}),frappe.realtime.on("update_communication",function(e){frappe.timeline.update_communication(e)}),frappe.realtime.on("doc_viewers",function(e){frappe.ui.form.set_viewers(e)})),this.initialized=!0}show_doc(e){var t=e[1],i=e.slice(2).join("/"),a=this;if(frappe.model.new_names[i])return i=frappe.model.new_names[i],void frappe.set_route("Form",t,i);frappe.model.with_doc(t,i,function(i,r){if(!r||!r[403])if(locals[t]&&locals[t][i])a.load(t,i);else{var n=__("New")+" ";if(i&&i.substr(0,n.length)==n){var s=frappe.model.make_new_doc_and_get_name(t,!0);s===i?a.load(t,i):frappe.set_route("Form",t,s)}else frappe.show_not_found(e)}})}load(e,t){frappe.container.change_to("Form/"+e),frappe.views.formview[e].frm.refresh(t)}},frappe.provide("_f"),frappe.provide("frappe.ui.form"),frappe.ui.form.Controller=Class.extend({init:function(e){$.extend(this,e)}}),_f.frms={},_f.Frm=function(e,t,i){this.docname="",this.doctype=e,this.hidden=!1,this.refresh_if_stale_for=120;var a=this;this.opendocs={},this.custom_buttons={},this.sections=[],this.grids=[],this.cscript=new frappe.ui.form.Controller({frm:this}),this.events={},this.pformat={},this.fetch_dict={},this.parent=t,this.tinymce_id_list=[],this.setup_meta(e),this.in_form=!!i,$(document).on("rename",function(e,t,i,r){t==a.doctype&&a.rename_notify(t,i,r)})},_f.Frm.prototype.check_doctype_conflict=function(e){"DocType"==this.doctype&&"DocType"==e?frappe.msgprint(__("Allowing DocType, DocType. Be careful!")):"DocType"==this.doctype?(frappe.views.formview[e]||frappe.pages["List/"+e])&&window.location.reload():frappe.views.formview.DocType&&frappe.views.formview.DocType.frm.opendocs[this.doctype]&&window.location.reload()},_f.Frm.prototype.setup=function(){this.fields=[],this.fields_dict={},this.state_fieldname=frappe.workflow.get_state_fieldname(this.doctype),this.wrapper=this.parent,this.$wrapper=$(this.wrapper),frappe.ui.make_app_page({parent:this.wrapper,single_column:this.meta.hide_toolbar}),this.page=this.wrapper.page,this.layout_main=this.page.main.get(0),this.toolbar=new frappe.ui.form.Toolbar({frm:this,page:this.page}),this.setup_print_layout(),this.setup_std_layout(),this.script_manager=new frappe.ui.form.ScriptManager({frm:this}),this.script_manager.setup(),this.watch_model_updates(),this.meta.hide_toolbar||(this.footer=new frappe.ui.form.Footer({frm:this,parent:$("<div>").appendTo(this.page.main.parent())}),$("body").attr("data-sidebar",1)),this.setup_drag_drop(),this.setup_done=!0},_f.Frm.prototype.setup_drag_drop=function(){var e=this;this.$wrapper.on("dragenter dragover",!1).on("drop",function(t){var i=t.originalEvent.dataTransfer;if(i&&i.files&&i.files.length>0){if(t.stopPropagation(),t.preventDefault(),e.doc.__islocal)throw frappe.msgprint(__("Please save before attaching.")),"attach error";if(e.attachments.max_reached())throw frappe.msgprint(__("Maximum Attachment Limit for this record reached.")),"attach error";frappe.upload.make({args:e.attachments.get_args(),files:i.files,callback:function(t,i){e.attachments.attachment_uploaded(t,i)}})}})},_f.Frm.prototype.setup_print_layout=function(){var e=this;this.print_preview=new frappe.ui.form.PrintPreview({frm:this}),this.page.wrapper.on("view-change",function(){e.toolbar.set_primary_action()})},_f.Frm.prototype.print_doc=function(){this.print_preview.wrapper.is(":visible")?this.hide_print():frappe.model.can_print(this.doc.doctype,this)?(this.print_preview.refresh_print_options().trigger("change"),this.page.set_view("print"),this.print_preview.set_user_lang(),this.print_preview.set_default_print_language(),this.print_preview.preview()):frappe.msgprint(__("You are not allowed to print this document"))},_f.Frm.prototype.hide_print=function(){this.setup_done&&"print"===this.page.current_view_name&&this.page.set_view("print"===this.page.previous_view_name?"main":this.page.previous_view_name||"main")},_f.Frm.prototype.watch_model_updates=function(){var e=this;frappe.model.on(e.doctype,"*",function(t,i,a){if(a.name===e.docname)return(""!==i&&null!==i||a[t])&&e.dirty(),e.fields_dict[t]&&e.fields_dict[t].refresh(t),e.layout.refresh_dependency(),e.script_manager.trigger(t,a.doctype,a.name)});var t=frappe.get_children("DocType",e.doctype,"fields",{fieldtype:"Table"});$.each(t,function(t,i){frappe.model.on(i.options,"*",function(t,a,r){r.parent===e.docname&&r.parentfield===i.fieldname&&(e.dirty(),e.fields_dict[i.fieldname].grid.set_value(t,a,r),e.script_manager.trigger(t,r.doctype,r.name))})})},_f.Frm.prototype.setup_std_layout=function(){this.form_wrapper=$("<div></div>").appendTo(this.layout_main),this.body=$("<div></div>").appendTo(this.form_wrapper),this.meta.section_style="Simple",this.layout=new frappe.ui.form.Layout({parent:this.body,doctype:this.doctype,frm:this,with_dashboard:!0}),this.layout.make(),this.fields_dict=this.layout.fields_dict,this.fields=this.layout.fields_list,this.document_flow=new frappe.ui.form.DocumentFlow({frm:this}),this.dashboard=new frappe.ui.form.Dashboard({frm:this}),this.states=new frappe.ui.form.States({frm:this})},_f.Frm.prototype.email_doc=function(e){new frappe.views.CommunicationComposer({doc:this.doc,frm:this,subject:__(this.meta.name)+": "+this.docname,recipients:this.doc.email||this.doc.email_id||this.doc.contact_email,attach_document_print:!0,message:e,real_name:this.doc.real_name||this.doc.contact_display||this.doc.contact_name})},_f.Frm.prototype.rename_doc=function(){frappe.model.rename_doc(this.doctype,this.docname)},_f.Frm.prototype.share_doc=function(){this.shared.show()},_f.Frm.prototype.rename_notify=function(e,t,i){this.meta.istable||this.docname==t&&(this.docname=i,this&&this.opendocs[t]&&frappe.meta.docfield_copy[e]&&(frappe.meta.docfield_copy[e][i]=frappe.meta.docfield_copy[e][t],delete frappe.meta.docfield_copy[e][t]),delete this.opendocs[t],this.opendocs[i]=!0,!this.meta.in_dialog&&this.in_form&&(frappe.re_route[window.location.hash]="#Form/"+encodeURIComponent(this.doctype)+"/"+encodeURIComponent(i),frappe.set_route("Form",this.doctype,i)))},_f.Frm.prototype.setup_meta=function(){this.meta=frappe.get_doc("DocType",this.doctype),this.perm=frappe.perm.get_perm(this.doctype),this.meta.istable&&(this.meta.in_dialog=1)},_f.Frm.prototype.refresh_header=function(e){this.meta.in_dialog&&!this.in_form||frappe.utils.set_title(this.meta.issingle?this.doctype:this.docname),this.toolbar&&(e&&(this.toolbar.current_status=void 0),this.toolbar.refresh()),this.document_flow.refresh(),this.dashboard.refresh(),this.meta.is_submittable&&this.perm[0]&&this.perm[0].submit&&!this.is_dirty()&&!this.is_new()&&!frappe.model.has_workflow(this.doctype)&&0===this.doc.docstatus&&this.dashboard.add_comment(__("Submit this document to confirm"),"orange",!0),this.clear_custom_buttons(),this.show_web_link()},_f.Frm.prototype.show_web_link=function(){var e=this.doc;!e.__islocal&&e.__onload&&e.__onload.is_website_generator&&(this.web_link&&this.web_link.remove(),e.__onload.published&&this.add_web_link("/"+e.route))},_f.Frm.prototype.add_web_link=function(e,t){t=t||"See on Website",this.web_link=this.sidebar.add_user_action(__(t),function(){}).attr("href",e||this.doc.route).attr("target","_blank")},_f.Frm.prototype.check_doc_perm=function(){var e=this.parent_doctype?this.parent_doctype:this.doctype;return this.perm=frappe.perm.get_perm(e,this.doc),this.perm[0].read?1:0},_f.Frm.prototype.refresh=function(e){var t=!!e;if(e&&(this.docname==e||this.meta.in_dialog&&!this.in_form||this.meta.istable||(frappe.utils.scroll_to(0),this.hide_print()),this.grids.forEach(function(e){return e.grid.visible_columns=null}),frappe.ui.form.close_grid_form(),this.docname=e),cur_frm=this,this.docname){if(this.doc=frappe.get_doc(this.doctype,this.docname),!this.check_doc_perm())return void frappe.show_not_permitted(__(this.doctype)+" "+__(this.docname));if(this.read_only=frappe.workflow.is_read_only(this.doctype,this.docname),this.read_only&&this.set_read_only(!0),this.opendocs[this.docname]){if(this.doc&&!this.doc.__unsaved&&this.doc.__last_sync_on&&new Date-this.doc.__last_sync_on>1e3*this.refresh_if_stale_for)return void this.reload_doc()}else this.check_doctype_conflict(this.docname);if(this.setup_done||this.setup(),this.cscript.is_onload=!1,this.opendocs[this.docname])this.render_form(t),this.doc.localname&&(delete this.doc.localname,$(document).trigger("form-rename",[this]));else{var i=this;this.cscript.is_onload=!0,this.setnewdoc(),$(document).trigger("form-load",[this]),$(this.page.wrapper).on("hide",function(){$(document).trigger("form-unload",[i])})}this.print_preview.wrapper.is(":visible")&&this.print_preview.preview(),t&&this.show_print_first&&1===this.doc.docstatus&&this.print_doc(),this.$wrapper.removeClass("validated-form").toggleClass("editable-form",0===this.doc.docstatus).toggleClass("submitted-form",1===this.doc.docstatus).toggleClass("cancelled-form",2===this.doc.docstatus),this.show_if_needs_refresh()}},_f.Frm.prototype.show_if_needs_refresh=function(){this.doc.__needs_refresh&&(this.doc.__unsaved?(this.dashboard.clear_headline(),this.dashboard.set_headline_alert(__("This form has been modified after you have loaded it")+'<a class="btn btn-xs btn-primary pull-right" onclick="cur_frm.reload_doc()">'+__("Refresh")+"</a>","alert-warning")):this.reload_doc())},_f.Frm.prototype.render_form=function(e){var t=this;if(this.meta.istable)this.refresh_header(e);else if(this.layout.doc=this.doc,this.layout.attach_doc_and_docfields(),this.sidebar=new frappe.ui.form.Sidebar({frm:this,page:this.page}),this.sidebar.make(),this.layout.show_message(),frappe.run_serially([function(){return t.refresh_header(e)},function(){return $(document).trigger("form-refresh",[t])},function(){return t.refresh_fields()},function(){return t.script_manager.trigger("refresh")},function(){if(t.cscript.is_onload)return t.script_manager.trigger("onload_post_render")},function(){return t.dashboard.after_refresh()}]),this.is_new()){var i=this.form_wrapper.find(".form-layout input:first");in_list(["Date","Datetime"],i.attr("data-fieldtype"))||i.focus()}this.$wrapper.trigger("render_complete"),this.hidden||this.layout.show_empty_form_message(),this.scroll_to_element()},_f.Frm.prototype.refresh_field=function(e){this.fields_dict[e]&&this.fields_dict[e].refresh&&(this.fields_dict[e].refresh(),this.layout.refresh_dependency())},_f.Frm.prototype.refresh_fields=function(){this.layout.refresh(this.doc),this.layout.primary_button=this.$wrapper.find(".btn-primary"),this.cleanup_refresh(this)},_f.Frm.prototype.cleanup_refresh=function(){var e=this;if(e.fields_dict.amended_from&&(e.doc.amended_from?(unhide_field("amended_from"),e.fields_dict.amendment_date&&unhide_field("amendment_date")):(hide_field("amended_from"),e.fields_dict.amendment_date&&hide_field("amendment_date"))),e.fields_dict.trash_reason&&(e.doc.trash_reason&&2==e.doc.docstatus?unhide_field("trash_reason"):hide_field("trash_reason")),e.meta.autoname&&"field:"==e.meta.autoname.substr(0,6)&&!e.doc.__islocal){var t=e.meta.autoname.substr(6);e.doc[t]&&e.toggle_display(t,!1)}"naming_series:"!=e.meta.autoname||e.doc.__islocal||e.toggle_display("naming_series",!1)},_f.Frm.prototype.setnewdoc=function(){var e=this;this.script_manager.trigger("before_load",this.doctype,this.docname).then(function(){e.script_manager.trigger("onload"),e.opendocs[e.docname]=!0,e.render_form(),frappe.after_ajax(function(){e.trigger_link_fields()}),frappe.breadcrumbs.add(e.meta.module,e.doctype)}),this.meta.track_seen&&$('.list-id[data-name="'+e.docname+'"]').addClass("seen")},_f.Frm.prototype.trigger_link_fields=function(){this.is_new()&&this.doc.__run_link_triggers&&($.each(this.fields_dict,function(e,t){"Link"==t.df.fieldtype&&this.doc[e]&&t.set_value(this.doc[e])}),delete this.doc.__run_link_triggers)},_f.Frm.prototype.runscript=function(e,t,i){var a=this;this.docname&&(t&&$(t.input).set_working(),frappe.call({method:"runserverobj",args:{docs:this.doc,method:e},btn:t.$input,callback:function(e){e.exc||(i&&i(e),a.refresh_fields())}}))},_f.Frm.prototype.copy_doc=function(e,t){this.validate_form_action("Create");var i=frappe.model.copy_doc(this.doc,t);i.idx=null,i.__run_link_triggers=!1,e&&e(i),frappe.set_route("Form",i.doctype,i.name)},_f.Frm.prototype.reload_doc=function(){this.check_doctype_conflict(this.docname);var e=this;e.doc.__islocal||(frappe.model.remove_from_locals(e.doctype,e.docname),frappe.model.with_doc(e.doctype,e.docname,function(){e.refresh()}))},frappe.validated=0,Object.defineProperty(window,"validated",{get:function(){return console.warn("Please use `frappe.validated` instead of `validated`. It will be deprecated soon."),frappe.validated},set:function(e){return console.warn("Please use `frappe.validated` instead of `validated`. It will be deprecated soon."),frappe.validated=e,frappe.validated}}),_f.Frm.prototype.save=function(e,t,i,a){var r=this;return new Promise(function(n,s){i&&$(i).prop("disabled",!0),$(document.activeElement).blur(),frappe.ui.form.close_grid_form(),setTimeout(function(){r._save(e,t,i,a,n,s)},100)}).then(function(){r.show_success_action()}).catch(function(e){console.error(e)})},_f.Frm.prototype._save=function(e,t,i,a,r,n){var s=this,o=this;e||(e="Save"),this.validate_form_action(e,r),this.meta.in_dialog&&!this.in_form||this.meta.istable||frappe.utils.scroll_to(0);var d=function(i){i.exc?a&&(a(),n()):(-1!==["Save","Update","Amend"].indexOf(e)&&frappe.utils.play_sound("click"),o.script_manager.trigger("after_save"),o.refresh()),t&&t(i),r()},c=function(){i&&$(i).prop("disabled",!1),a&&(a(),n())};"Update"!=e?(frappe.validated=!0,frappe.run_serially([function(){return s.script_manager.trigger("validate")},function(){return s.script_manager.trigger("before_save")},function(){frappe.validated?frappe.ui.form.save(o,e,d,i):c()}]).catch(c)):frappe.ui.form.save(o,e,d,i)},_f.Frm.prototype.savesubmit=function(e,t,i){var a=this,r=this,n=function(){$(e).prop("disabled",!1),i&&i()};return new Promise(function(i){a.validate_form_action("Submit"),frappe.confirm(__("Permanently Submit {0}?",[a.docname]),function(){frappe.validated=!0,r.script_manager.trigger("before_submit").then(function(){frappe.validated?r.save("Submit",function(e){e.exc?n():(frappe.utils.play_sound("submit"),t&&t(),r.script_manager.trigger("on_submit").then(function(){return i(r)}))},e,function(){return n()},i):n()})},function(){return n()})})},_f.Frm.prototype.savecancel=function(e,t,i){var a=this,r=function(){$(e).prop("disabled",!1),i&&i()};this.validate_form_action("Cancel"),frappe.confirm(__("Permanently Cancel {0}?",[this.docname]),function(){frappe.validated=!0,a.script_manager.trigger("before_cancel").then(function(){if(frappe.validated){frappe.ui.form.save(a,"cancel",function(e){e.exc?r():(frappe.utils.play_sound("cancel"),a.refresh(),t&&t(),a.script_manager.trigger("after_cancel"))},e)}else r()})},function(){return r()})},_f.Frm.prototype.savetrash=function(){this.validate_form_action("Delete"),frappe.model.delete_doc(this.doctype,this.docname,function(){window.history.back()})},_f.Frm.prototype.amend_doc=function(){if(this.fields_dict.amended_from){this.validate_form_action("Amend");var e=this;this.copy_doc(function(t){t.amended_from=e.docname,e.fields_dict&&e.fields_dict.amendment_date&&(t.amendment_date=frappe.datetime.obj_to_str(new Date))},1),frappe.utils.play_sound("click")}else alert('"amended_from" field must be present to do an amendment.')},_f.Frm.prototype.disable_save=function(){this.save_disabled=!0,this.toolbar.current_status=null,this.page.clear_primary_action()},_f.Frm.prototype.enable_save=function(){this.save_disabled=!1,this.toolbar.set_primary_action()},_f.Frm.prototype.save_or_update=function(){this.save_disabled||(0===this.doc.docstatus?this.save():1===this.doc.docstatus&&this.doc.__unsaved&&this.save("Update"))},_f.Frm.prototype.dirty=function(){this.doc.__unsaved=1,this.$wrapper.trigger("dirty")},_f.Frm.prototype.get_docinfo=function(){return frappe.model.docinfo[this.doctype][this.docname]},_f.Frm.prototype.is_dirty=function(){return this.doc.__unsaved},_f.Frm.prototype.is_new=function(){return this.doc.__islocal},_f.Frm.prototype.reload_docinfo=function(e){var t=this;frappe.call({method:"frappe.desk.form.load.get_docinfo",args:{doctype:t.doctype,name:t.doc.name},callback:function(i){e&&e(i.docinfo),t.timeline.refresh(),t.assign_to.refresh(),t.attachments.refresh()}})},_f.Frm.prototype.get_perm=function(e,t){return this.perm[e]?this.perm[e][t]:null},_f.Frm.prototype.set_intro=function(e){this.dashboard.set_headline_alert(e)},_f.Frm.prototype.set_footnote=function(e){this.footnote_area=frappe.utils.set_footnote(this.footnote_area,this.body,e)},_f.Frm.prototype.add_custom_button=function(e,t,i){i&&-1!==i.indexOf("fa fa-")&&(i=null);var a=this.page.add_inner_button(e,t,i);return a&&(this.custom_buttons[e]=a),a},_f.Frm.prototype.clear_custom_buttons=function(){this.page.clear_inner_toolbar(),this.page.clear_user_actions(),this.custom_buttons={}},_f.Frm.prototype.remove_custom_button=function(e,t){this.page.remove_inner_button(e,t)},_f.Frm.prototype.add_fetch=function(e,t,i){this.fetch_dict[e]||(this.fetch_dict[e]={columns:[],fields:[]}),this.fetch_dict[e].columns.push(t),this.fetch_dict[e].fields.push(i)},_f.Frm.prototype.set_print_heading=function(e){this.pformat[this.docname]=e},_f.Frm.prototype.action_perm_type_map={Create:"create",Save:"write",Submit:"submit",Update:"submit",Cancel:"cancel",Amend:"amend",Delete:"delete"},_f.Frm.prototype.validate_form_action=function(e,t){var i=this.action_perm_type_map[e],a=!1,r=frappe.perm.get_perm(this.doc.doctype)[0];(frappe.workflow.is_read_only(this.doctype,this.docname)&&(r.write||r.create||r.submit||r.cancel)||!frappe.workflow.is_read_only(this.doctype,this.docname))&&(a=!0),this.perm[0][i]||a||(t&&t(),frappe.throw(__("No permission to '{0}' {1}",[__(e),__(this.doc.doctype)])))},_f.Frm.prototype.has_perm=function(e){return frappe.perm.has_perm(this.doctype,0,e,this.doc)},_f.Frm.prototype.scroll_to_element=function(){if(frappe.route_options&&frappe.route_options.scroll_to){var e=frappe.route_options.scroll_to;delete frappe.route_options.scroll_to;var t=[];for(var i in e){var a=e[i];t.push(repl('[data-%(key)s="%(value)s"]',{key:i,value:a}))}(t=$(t.join(" "))).length&&frappe.utils.scroll_to(t)}},_f.Frm.prototype.show_success_action=function(){"Form"===frappe.get_route()[0]&&(this.meta.is_submittable&&1!==this.doc.docstatus||new frappe.ui.form.SuccessAction(this).show())},_f.Frm.prototype.is_first_creation=function(){var e=this.doc,t=e.modified,i=e.creation;return(t=t.split(".")[0])===(i=i.split(".")[0])},window.get_server_fields=function(e,t,i,a,r,n,s,o){return console.warn("This function 'get_server_fields' has been deprecated and will be removed soon."),frappe.dom.freeze(),$.isPlainObject(t)&&(t=JSON.stringify(t)),$c("runserverobj",{method:e,docs:JSON.stringify(a),arg:t},function(e){if(frappe.dom.unfreeze(),e.message){var t=locals[r][n],s=e.message;for(var d in s)t[d]=s[d],i?refresh_field(d,t.name,i):refresh_field(d)}o&&(a=locals[a.doctype][a.name],o(a,r,n))})},window.set_multiple=function(e,t,i,a){var r=locals[e][t];for(var n in i)r[n]=i[n],a?refresh_field(n,r.name,a):refresh_field(n)},window.refresh_many=function(e,t,i){for(var a in e)i?refresh_field(e[a],t,i):refresh_field(e[a])},window.set_field_tip=function(e,t){var i=frappe.meta.get_docfield(cur_frm.doctype,e,cur_frm.docname);i&&(i.description=t),cur_frm&&cur_frm.fields_dict&&(cur_frm.fields_dict[e]?cur_frm.fields_dict[e].comment_area.innerHTML=frappe.utils.replace_newlines(t):console.log("[set_field_tip] Unable to set field tip: "+e))},window.refresh_field=function(e,t,i){if(typeof e==typeof[]&&refresh_many(e,t,i),e&&"string"==typeof e&&i){var a=cur_frm.fields_dict[i].grid,r=frappe.utils.filter_dict(a.docfields,{fieldname:e});if(r&&r.length){r=r[0];var n=frappe.meta.get_docfield(r.parent,r.fieldname,t);$.extend(r,n),t?cur_frm.fields_dict[i].grid.grid_rows_by_docname[t].refresh_field(e):cur_frm.fields_dict[i].grid.refresh()}}else cur_frm&&cur_frm.refresh_field(e)},window.set_field_options=function(e,t){cur_frm.set_df_property(e,"options",t)},window.set_field_permlevel=function(e,t){cur_frm.set_df_property(e,"permlevel",t)},window.toggle_field=function(e,t){var i=frappe.meta.get_docfield(cur_frm.doctype,e,cur_frm.docname);i?(i.hidden=t,refresh_field(e)):console.log((t?"hide_field":"unhide_field")+" cannot find field "+e)},window.hide_field=function(e){if(cur_frm)if(e.substr)toggle_field(e,1);else for(var t in e)toggle_field(e[t],1)},window.unhide_field=function(e){if(cur_frm)if(e.substr)toggle_field(e,0);else for(var t in e)toggle_field(e[t],0)},window.get_field_obj=function(e){return cur_frm.fields_dict[e]},_f.Frm.prototype.get_doc=function(){return locals[this.doctype][this.docname]},_f.Frm.prototype.set_currency_labels=function(e,t,i){var a=this,r=i?this.fields_dict[i].grid.doctype:this.doc.doctype,n={},s={};$.each(e,function(e,a){var o=frappe.meta.docfield_map[r][a];if(o){var d=__(o.label||"").replace(/\([^\)]*\)/g,"");i?s[r+"-"+a]=d.trim()+" ("+__(t)+")":n[a]=d.trim()+" ("+t+")"}}),$.each(n,function(e,t){a.fields_dict[e].set_label(t)}),$.each(s,function(e,t){e=e.split("-");var i=frappe.meta.get_docfield(e[0],e[1],a.doc.name);i&&(i.label=t)})},_f.Frm.prototype.field_map=function(e,t){"string"==typeof e&&(e="*"==e?Object.keys(this.fields_dict):[e]);for(var i=0,a=e.length;i<a;i++){var r=e[i],n=frappe.meta.get_docfield(cur_frm.doctype,r,this.docname);n&&(t(n),this.refresh_field(r))}},_f.Frm.prototype.get_docfield=function(e,t){if(t){var i=this.get_docfield(e).options;return frappe.meta.get_docfield(i,t,this.docname)}return frappe.meta.get_docfield(this.doctype,e,this.docname)},_f.Frm.prototype.set_df_property=function(e,t,i,a,r){var n;if(a||r){var s=this.fields_dict[r].grid,o=frappe.utils.filter_dict(s.docfields,{fieldname:e});o&&o.length&&(n=frappe.meta.get_docfield(o[0].parent,e,a))}else n=this.get_docfield(e);n&&n[t]!=i&&(n[t]=i,refresh_field(e,r))},_f.Frm.prototype.toggle_enable=function(e,t){this.field_map(e,function(e){e.read_only=t?0:1})},_f.Frm.prototype.toggle_reqd=function(e,t){this.field_map(e,function(e){e.reqd=!!t})},_f.Frm.prototype.toggle_display=function(e,t){this.field_map(e,function(e){e.hidden=t?0:1})},_f.Frm.prototype.call_server=function(e,t,i){return $c_obj(this.doc,e,t,i)},_f.Frm.prototype.get_files=function(){return this.attachments?frappe.utils.sort(this.attachments.get_attachments(),"file_name","string"):[]},_f.Frm.prototype.set_query=function(e,t,i){i?this.fields_dict[t].grid.get_field(e).get_query=i:this.fields_dict[e]&&(this.fields_dict[e].get_query=t)},_f.Frm.prototype.set_value_if_missing=function(e,t){return this.set_value(e,t,!0)},_f.Frm.prototype.clear_table=function(e){frappe.model.clear_table(this.doc,e)},_f.Frm.prototype.add_child=function(e,t){var i=frappe.model.add_child(this.doc,frappe.meta.get_docfield(this.doctype,e).options,e);if(t){var a={},r=["idx","name"];Object.keys(t).map(function(e){r.includes(e)||(a[e]=t[e])}),$.extend(i,a)}return i},_f.Frm.prototype.set_value=function(e,t,i){var a=this,r=function(e,t){var r=a.fields_dict[e];if(!r)throw frappe.msgprint(__("Field {0} not found.",[e])),"frm.set_value";if(!i||!frappe.model.has_value(a.doctype,a.doc.name,e)){if("Table"===r.df.fieldtype&&$.isArray(t)){frappe.model.clear_table(a.doc,r.df.fieldname);for(var n=0,s=t.length;n<s;n++){var o=t[n],d=frappe.model.add_child(a.doc,r.df.options,r.df.fieldname,n+1);$.extend(d,o)}return a.refresh_field(e),Promise.resolve()}return frappe.model.set_value(a.doctype,a.doc.name,e,t)}};if("string"==typeof e)return r(e,t);if($.isPlainObject(e)){var n=[],s=function(t){var i=e[t];a.get_field(t)&&n.push(function(){return r(t,i)})};for(var o in e)s(o);return frappe.run_serially(n)}},_f.Frm.prototype.call=function(e,t,i){var a=this;return"string"==typeof e&&(e={method:e,doc:this.doc,args:t,callback:i}),e.doc?(e.original_callback=e.callback,e.callback=function(t){t.exc||a.refresh_fields(),e.original_callback&&e.original_callback(t)}):(-1===e.method.indexOf(".")&&(e.method=frappe.model.get_server_module_name(a.doctype)+"."+e.method),e.original_callback=e.callback,e.callback=function(t){if($.isPlainObject(t.message))if(e.child){e.child=locals[e.child.doctype][e.child.name];var i=["doctype"].concat(frappe.model.std_fields_list);for(var r in t.message)-1===i.indexOf(r)&&(e.child[r]=t.message[r]);a.fields_dict[e.child.parentfield].refresh()}else a.set_value(t.message);e.original_callback&&e.original_callback(t)}),frappe.call(e)},_f.Frm.prototype.get_field=function(e){return this.fields_dict[e]},_f.Frm.prototype.set_read_only=function(){for(var e=[],t=frappe.perm.get_perm(this.doc.doctype),i=0,a=t.length;i<a;i++){e[t[i].permlevel||0]={read:1,print:1,cancel:1}}this.perm=e},_f.Frm.prototype.trigger=function(e){return this.script_manager.trigger(e)},_f.Frm.prototype.get_formatted=function(e){return frappe.format(this.doc[e],frappe.meta.get_docfield(this.doctype,e,this.docname),{no_icon:!0},this.doc)},_f.Frm.prototype.open_grid_row=function(){return frappe.ui.form.get_open_grid_form()},_f.Frm.prototype.is_new=function(){return this.doc.__islocal},_f.Frm.prototype.get_title=function(){return this.meta.title_field?this.doc[this.meta.title_field]:this.doc.name},_f.Frm.prototype.get_selected=function(){var e={},t=this;return frappe.meta.get_table_fields(this.doctype).forEach(function(i){var a=t.fields_dict[i.fieldname].grid.get_selected();a.length&&(e[i.fieldname]=a)}),e},_f.Frm.prototype.has_mapper=function(){return void 0===this._has_mapper&&(this._has_mapper=!(!this.meta.__js||-1===this.meta.__js.search("open_mapped_doc"))),this._has_mapper},_f.Frm.prototype.set_indicator_formatter=function(e,t,i){var a;frappe.meta.docfield_map[this.doctype][e]?a=this.doctype:frappe.meta.get_table_fields(this.doctype).every(function(t){return!frappe.meta.docfield_map[t.options][e]||(a=t.options,!1)}),frappe.meta.docfield_map[a][e].formatter=function(e,a,r,n){if(e){var s;s=i?i(n):frappe.form.link_formatters[a.options]?frappe.form.link_formatters[a.options](e,n):e;var o=encodeURIComponent(e);return repl('<a class="indicator %(color)s" href="#Form/%(doctype)s/%(name)s">%(label)s</a>',{color:t(n||{}),doctype:a.options,name:o,label:s})}return""}},_f.Frm.prototype.can_create=function(e){if(!frappe.model.can_create(e))return!1;if(this.custom_make_buttons&&this.custom_make_buttons[e]){var t=__(this.custom_make_buttons[e]);return!!this.custom_buttons[t]}return this.can_make_methods&&this.can_make_methods[e]?this.can_make_methods[e](this):!this.meta.is_submittable||1!=!this.doc.docstatus},_f.Frm.prototype.make_new=function(e){var t=this;if(this.make_methods&&this.make_methods[e])return this.make_methods[e](this);this.custom_make_buttons&&this.custom_make_buttons[e]?this.custom_buttons[__(this.custom_make_buttons[e])].trigger("click"):frappe.model.with_doctype(e,function(){var i=frappe.model.get_new_doc(e);frappe.get_meta(e).fields.forEach(function(e){"Link"===e.fieldtype&&e.options===t.doctype&&(i[e.fieldname]=t.doc.name)}),frappe.ui.form.make_quick_entry(e,null,null,i)})},_f.Frm.prototype.update_in_all_rows=function(e,t,i){if(i){for(var a=this.doc[e]||[],r=0;r<a.length;r++)a[r][t]||(a[r][t]=i);refresh_field("items")}},_f.Frm.prototype.get_sum=function(e,t){for(var i=0,a=0,r=this.doc[e]||[];a<r.length;a+=1){i+=r[a][t]}return i},frappe.provide("frappe.ui.form"),frappe.ui.form.Toolbar=Class.extend({init:function(e){$.extend(this,e),this.refresh(),this.add_update_button_on_dirty(),this.setup_editable_title()},refresh:function(){this.make_menu(),this.set_title(),this.page.clear_user_actions(),this.show_title_as_dirty(),this.set_primary_action(),this.frm.meta.hide_toolbar?this.page.hide_menu():this.frm.doc.__islocal?(this.page.hide_menu(),this.print_icon&&this.print_icon.addClass("hide")):(this.page.show_menu(),this.print_icon&&this.print_icon.removeClass("hide"))},set_title:function(){if(this.frm.meta.title_field){var e=strip_html((this.frm.doc[this.frm.meta.title_field]||"").trim()||this.frm.docname);this.frm.doc.__islocal||e===this.frm.docname||"hash"===this.frm.meta.autoname?this.page.set_title_sub(""):this.page.set_title_sub(this.frm.docname)}else e=this.frm.docname;e=__(e),this.page.set_title(e),this.frm.meta.title_field&&frappe.utils.set_title(e+" - "+this.frm.docname),this.page.$title_area.toggleClass("editable-title",!(!this.is_title_editable()&&!this.can_rename())),this.set_indicator()},is_title_editable:function(){return!("title"!==this.frm.meta.title_field||!this.frm.perm[0].write||this.frm.get_docfield("title").options||this.frm.doc.__islocal)},can_rename:function(){return this.frm.perm[0].write&&this.frm.meta.allow_rename&&!this.frm.doc.__islocal},setup_editable_title:function(){var e=this;this.page.$title_area.find(".title-text").on("click",function(){e.is_title_editable()&&frappe.prompt({fieldname:"title",fieldtype:"Data",label:__("Title"),reqd:1,default:e.frm.doc.title},function(t){t.title&&(e.frm.set_value("title",t.title),e.frm.doc.__islocal?e.set_title():e.frm.save_or_update())},__("Edit Title"),__("Update")),e.can_rename()&&e.frm.rename_doc()})},get_dropdown_menu:function(e){return this.page.add_dropdown(e)},set_indicator:function(){if(!this.frm.save_disabled){var e=frappe.get_indicator(this.frm.doc);e?this.page.set_indicator(e[0],e[1]):this.page.clear_indicator()}},make_menu:function(){this.page.clear_icons(),this.page.clear_menu();var e=this,t=this.frm.perm[0],i=cint(this.frm.doc.docstatus),a=frappe.model.is_submittable(this.frm.doc.doctype),r=this.frm.meta.issingle,n=frappe.model.get_doc(":Print Settings","Print Settings"),s=cint(n.allow_print_for_draft),o=cint(n.allow_print_for_cancelled);(!a||1==i||o&&2==i||s&&0==i)&&frappe.model.can_print(null,e.frm)&&!r&&(this.page.add_menu_item(__("Print"),function(){e.frm.print_doc()},!0),this.print_icon=this.page.add_action_icon("fa fa-print",function(){e.frm.print_doc()})),frappe.model.can_email(null,e.frm)&&e.frm.doc.docstatus<2&&this.page.add_menu_item(__("Email"),function(){e.frm.email_doc()},!0),e.frm.meta.issingle||this.page.add_menu_item(__("Links"),function(){e.show_linked_with()},!0),in_list(frappe.boot.user.can_create,e.frm.doctype)&&!e.frm.meta.allow_copy&&this.page.add_menu_item(__("Duplicate"),function(){e.frm.copy_doc()},!0),this.can_rename()&&this.page.add_menu_item(__("Rename"),function(){e.frm.rename_doc()},!0),this.page.add_menu_item(__("Reload"),function(){e.frm.reload_doc()},!0),e.frm.meta.issingle&&this.page.add_menu_item(__("Add to Desktop"),function(){frappe.add_to_desktop(e.frm.doctype,e.frm.doctype)},!0),1!=cint(e.frm.doc.docstatus)&&!e.frm.doc.__islocal&&frappe.model.can_delete(e.frm.doctype)&&this.page.add_menu_item(__("Delete"),function(){e.frm.savetrash()},!0),frappe.user_roles.includes("System Manager")&&(this.page.add_menu_item(__("Customize"),function(){frappe.set_route("Form","Customize Form",{doc_type:e.frm.doctype})},!0),1===frappe.boot.developer_mode&&e.frm.meta.issingle&&this.page.add_menu_item(__("Edit DocType"),function(){frappe.set_route("Form","DocType",e.frm.doctype)},!0)),this.frm.doc.__unsaved||a&&1==i&&this.page.add_menu_item(__("Request Feedback"),function(){(new frappe.utils.Feedback).manual_feedback_request(e.frm.doc)},!0),t[CREATE]&&!this.frm.meta.issingle&&this.page.add_menu_item(__("New {0} (Ctrl+B)",[__(e.frm.doctype)]),function(){frappe.new_doc(e.frm.doctype,!0)},!0)},can_save:function(){return 0===this.get_docstatus()},can_submit:function(){return 0===this.get_docstatus()&&!this.frm.doc.__islocal&&!this.frm.doc.__unsaved&&this.frm.perm[0].submit&&!this.has_workflow()},can_update:function(){return 1===this.get_docstatus()&&!this.frm.doc.__islocal&&this.frm.perm[0].submit&&this.frm.doc.__unsaved},can_cancel:function(){return 1===this.get_docstatus()&&this.frm.perm[0].cancel&&!this.read_only},can_amend:function(){return 2===this.get_docstatus()&&this.frm.perm[0].amend&&!this.read_only},has_workflow:function(){return void 0===this._has_workflow&&(this._has_workflow=frappe.get_list("Workflow",{document_type:this.frm.doctype}).length),this._has_workflow},get_docstatus:function(){return cint(this.frm.doc.docstatus)},show_linked_with:function(){this.frm.linked_with||(this.frm.linked_with=new frappe.ui.form.LinkedWith({frm:this.frm})),this.frm.linked_with.show()},set_primary_action:function(e){e||this.page.clear_user_actions();var t=this.get_action_status();t?t!==this.current_status&&this.set_page_actions(t):(this.page.clear_actions(),this.current_status=null)},get_action_status:function(){var e=null;return"print"===this.frm.page.current_view_name||this.frm.hidden?e="Edit":this.can_submit()?e="Submit":this.can_save()?this.frm.save_disabled||this.has_workflow()&&!this.frm.doc.__unsaved||(e="Save"):this.can_update()?e="Update":this.can_cancel()?e="Cancel":this.can_amend()&&(e="Amend"),e},set_page_actions:function(e){var t=this;if(this.page.clear_actions(),"Edit"!==e){var i=this.frm.action_perm_type_map[e];if(!this.frm.perm[0][i])return}if("Edit"===e)this.page.set_primary_action(__("Edit"),function(){t.frm.page.set_view("main")},"octicon octicon-pencil");else if("Cancel"===e)this.page.set_secondary_action(__(e),function(){t.frm.savecancel(this)},"octicon octicon-circle-slash");else{var a={Save:function(){return t.frm.save("Save",null,this)},Submit:function(){return t.frm.savesubmit(this)},Update:function(){return t.frm.save("Update",null,this)},Amend:function(){return t.frm.amend_doc()}}[e],r={Save:"octicon octicon-check",Submit:"octicon octicon-lock",Update:"octicon octicon-check",Amend:"octicon octicon-split"}[e];this.page.set_primary_action(__(e),a,r)}this.current_status=e},make_cancel_amend_button:function(){var e=this,t=cint(this.frm.doc.docstatus),i=this.frm.perm[0];this.has_workflow()||(1==t&&i[CANCEL]?this.page.set_secondary_action(__("Cancel"),function(){e.frm.savecancel(this)},"fa fa-ban-circle"):2==t&&i[AMEND]&&this.page.set_secondary_action(__("Amend"),function(){e.frm.amend_doc()},"fa fa-pencil",!0))},add_update_button_on_dirty:function(){var e=this;$(this.frm.wrapper).on("dirty",function(){e.show_title_as_dirty(),e.frm.page.clear_actions_menu(),e.frm.save_disabled||e.set_primary_action(!0)})},show_title_as_dirty:function(){this.frm.save_disabled||(this.frm.doc.__unsaved&&this.page.set_indicator(__("Not Saved"),"orange"),$(this.frm.wrapper).attr("data-state",this.frm.doc.__unsaved?"dirty":"clean"))}}),frappe.ui.form.Dashboard=Class.extend({init:function(e){$.extend(this,e),this.section=this.frm.fields_dict._form_dashboard.wrapper,this.parent=this.section.find(".section-body"),this.wrapper=$(frappe.render_template("form_dashboard",{frm:this.frm})).appendTo(this.parent),this.progress_area=this.wrapper.find(".progress-area"),this.heatmap_area=this.wrapper.find(".form-heatmap"),this.chart_area=this.wrapper.find(".form-graph"),this.stats_area=this.wrapper.find(".form-stats"),this.stats_area_row=this.stats_area.find(".row"),this.links_area=this.wrapper.find(".form-links"),this.transactions_area=this.links_area.find(".transactions")},reset:function(){this.section.addClass("hidden"),this.clear_headline(),this.progress_area.empty().addClass("hidden"),this.links_area.addClass("hidden"),this.links_area.find(".count, .open-notification").addClass("hidden"),this.stats_area.addClass("hidden"),this.stats_area_row.empty(),this.wrapper.find(".custom").remove()},set_headline:function(e){this.frm.layout.show_message(e)},clear_headline:function(){this.frm.layout.show_message()},add_comment:function(e,t,i){var a=this;this.set_headline_alert(e,t),i||setTimeout(function(){a.clear_headline()},1e4)},clear_comment:function(){this.clear_headline()},set_headline_alert:function(e,t){t||(t="orange"),e?this.set_headline('<div><span class="indicator '+t+'">'+e+"</span></div>"):this.clear_headline()},add_section:function(e){return $('<div class="form-dashboard-section custom">'+e+"</div>").appendTo(this.wrapper)},add_progress:function(e,t,i){var a=this.make_progress_chart(e);$.isArray(t)||(t=this.format_percent(e,t));var r=$('<div class="progress"></div>').appendTo(a);return $.each(t,function(e,t){$(repl('<div class="progress-bar %(progress_class)s" style="width: %(width)s" \t\t\t\ttitle="%(title)s"></div>',t)).appendTo(r)}),i||(i=""),$('<p class="progress-message text-muted small">'+i+"</p>").appendTo(a),this.show(),a},show_progress:function(e,t,i){if(this._progress_map=this._progress_map||{},!this._progress_map[e]){var a=this.add_progress(e,t,i);this._progress_map[e]=a}var r=this._progress_map[e];$.isArray(t)||(t=this.format_percent(e,t)),r.find(".progress-bar").each(function(e,i){var a=t[e],r=a.progress_class,n=a.width;$(i).css("width",n).removeClass("progress-bar-danger progress-bar-success").addClass(r)}),i||(i=""),r.find(".progress-message").text(i)},hide_progress:function(e){e?(this._progress_map[e].remove(),delete this._progress_map[e]):(this._progress_map={},this.progress_area.empty())},format_percent:function(e,t){var i=cint(t)<1?1:cint(t),a="";return i<10&&(a="progress-bar-danger"),i>99.9&&(a="progress-bar-success"),[{title:e,width:i+"%",progress_class:a}]},make_progress_chart:function(e){return $('<div class="progress-chart" title="'+(e||"")+'"></div>').appendTo(this.progress_area.removeClass("hidden"))},refresh:function(){if(this.reset(),!this.frm.doc.__islocal){this.data||this.init_data();var e=!1;if(this.data&&(this.data.transactions||[]).length){if(this.data.docstatus&&this.frm.doc.docstatus!==this.data.docstatus)return;this.render_links(),this.set_open_count(),e=!0}this.data.heatmap&&(this.render_heatmap(),e=!0),this.data.graph&&(this.setup_graph(),e=!0),e&&this.show()}},after_refresh:function(){var e=this;this.links_area.find(".btn-new").each(function(){e.frm.can_create($(this).attr("data-doctype"))&&$(this).removeClass("hidden")})},init_data:function(){this.data=this.frm.meta.__dashboard||{},this.data.transactions||(this.data.transactions=[]),this.data.internal_links||(this.data.internal_links={}),this.filter_permissions()},add_transactions:function(e){var t=this,i=[];Array.isArray(e)||(e=[e]),this.data||this.init_data(),this.data&&(this.data.transactions||[]).length&&(this.data.transactions.map(function(t){e.map(function(e){var a;e.label==t.label&&(i.push(e.label),(a=t.items).push.apply(a,e.items))})}),e.map(function(e){i.includes(e.label)||t.data.transactions.push(e)}),this.filter_permissions())},filter_permissions:function(){var e=[];(this.data.transactions||[]).forEach(function(t){var i=[];t.items.forEach(function(e){frappe.model.can_read(e)&&i.push(e)}),i.length&&(t.items=i,e.push(t))}),this.data.transactions=e},render_links:function(){var e=this;this.links_area.removeClass("hidden"),this.links_area.find(".btn-new").addClass("hidden"),this.data_rendered||(this.data.frm=this.frm,$(frappe.render_template("form_links",this.data)).appendTo(this.transactions_area),this.transactions_area.find(".badge-link").on("click",function(){e.open_document_list($(this).parent())}),this.transactions_area.find(".open-notification").on("click",function(){e.open_document_list($(this).parent(),!0)}),this.transactions_area.find(".btn-new").on("click",function(){e.frm.make_new($(this).attr("data-doctype"))}),this.data_rendered=!0)},open_document_list:function(e,t){var i=e.attr("data-doctype"),a=e.attr("data-names")||[];if(this.data.internal_links[i]){if(!a.length)return!1;frappe.route_options={name:["in",a]}}else this.data.fieldname&&(frappe.route_options=this.get_document_filter(i),t&&frappe.ui.notifications.show_open_count_list(i));frappe.set_route("List",i,"List")},get_document_filter:function(e){var t={};return t[this.data.non_standard_fieldnames&&this.data.non_standard_fieldnames[e]||this.data.fieldname]=this.frm.doc.name,t},set_open_count:function(){if(this.data.transactions&&this.data.fieldname){var e=[],t=this;this.data.transactions.forEach(function(t){t.items.forEach(function(t){e.push(t)})});var i=this.data.method||"frappe.desk.notifications.get_open_count";frappe.call({type:"GET",method:i,args:{doctype:this.frm.doctype,name:this.frm.doc.name,items:e},callback:function(e){e.message.timeline_data&&t.update_heatmap(e.message.timeline_data),$.each(e.message.count,function(e,i){t.frm.dashboard.set_badge_count(i.name,cint(i.open_count),cint(i.count))}),$.each(t.data.internal_links,function(e,i){var a=i[0],r=i[1],n=[];(t.frm.doc[a]||[]).forEach(function(e){var t=e[r];t&&-1===n.indexOf(t)&&n.push(t)}),t.frm.dashboard.set_badge_count(e,0,n.length,n)}),t.frm.dashboard_data=e.message,t.frm.trigger("dashboard_update")}})}},set_badge_count:function(e,t,i,a){var r=$(this.transactions_area).find('.document-link[data-doctype="'+e+'"]');t&&r.find(".open-notification").removeClass("hidden").html(t>99?"99+":t),i&&r.find(".count").removeClass("hidden").html(i>99?"99+":i),this.data.internal_links[e]&&(a&&a.length?r.attr("data-names",a?a.join(","):""):r.find("a").attr("disabled",!0))},update_heatmap:function(e){this.heatmap&&this.heatmap.update(e)},render_heatmap:function(){if(!this.heatmap){this.heatmap=new Chart("#heatmap-"+frappe.model.scrub(this.frm.doctype),{type:"heatmap",height:120,start:new Date(moment().subtract(1,"year").toDate()),count_label:"interactions",discreteDomains:0,data:{}}),this.heatmap_area.removeClass("hidden").find("svg").css({margin:"auto"});var e=this.heatmap_area.find(".heatmap-message");this.data.heatmap_message?e.removeClass("hidden").html(this.data.heatmap_message):e.addClass("hidden")}},add_indicator:function(e,t){this.show(),this.stats_area.removeClass("hidden");var i,a=this.stats_area_row.find(".indicator-column"),r=a.length+1;return i=r>4?3:12/r,a.length&&a.removeClass().addClass("col-sm-"+i).addClass("indicator-column"),$('<div class="col-sm-'+i+' indicator-column"><span class="indicator '+t+'">'+e+"</span></div>").appendTo(this.stats_area_row)},setup_graph:function(){var e=this,t=this.data.graph_method,i={doctype:this.frm.doctype,docname:this.frm.doc.name};$.extend(i,this.data.graph_method_args),frappe.call({type:"GET",method:t,args:i,callback:function(t){t.message&&e.render_graph(t.message)}})},render_graph:function(e){this.chart_area.empty().removeClass("hidden"),$.extend(e,{type:"line",colors:["green"]}),this.show(),this.chart=new Chart(".form-graph",e),this.chart||this.hide()},show:function(){this.section.removeClass("hidden")},hide:function(){this.section.addClass("hidden")}}),frappe.provide("frappe.document_flow"),frappe.ui.form.DocumentFlow=Class.extend({init:function(e){$.extend(this,e),this.module=frappe.get_meta(this.frm.doctype).module,frappe.document_flow&&frappe.document_flow[this.module]&&(this.doctypes=frappe.document_flow[this.module][this.frm.doctype],this.doctypes&&(this.wrapper=$('<div class="document-flow-wrapper hidden"></div>').prependTo(this.frm.layout.wrapper)))},refresh:function(){this.doctypes&&(this.reset(),this.render())},reset:function(){this.wrapper.empty().addClass("hidden"),this.linked_with={}},render:function(){var e=this;$(frappe.render_template("form_document_flow",{frm:this.frm,doctypes:this.doctypes})).appendTo(this.wrapper.removeClass("hidden")),this.wrapper.on("click",".document-flow-link",function(){var t=$(this).attr("data-doctype");if(e.frm.doctype!=t)return e.get_linked_docs(t),!1}),this.frm.doc.__islocal||this.mark_completed_flow()},get_linked_docs:function(e){this.linked_with[e]||(this.linked_with[e]=new frappe.ui.form.LinkedWith({frm:this.frm,for_doctype:e})),this.linked_with[e].show()},mark_completed_flow:function(){var e=this;frappe.call({method:"frappe.desk.form.document_flow.get_document_completion_status",args:{doctypes:e.doctypes,frm_doctype:e.frm.doctype,frm_docname:e.frm.docname},callback:function(t){t.message&&$.each(e.doctypes,function(i,a){t.message[a]&&e.frm.doctype!=a&&e.wrapper.find("[data-doctype='"+a+"']a .indicator").removeClass("darkgrey").addClass("black")})}})}}),frappe.provide("frappe.ui.form"),frappe.ui.form.save=function(e,t,i,a){$(a).prop("disabled",!0);var r,n,s={Save:__("Saving"),Submit:__("Submitting"),Update:__("Updating"),Amend:__("Amending"),Cancel:__("Cancelling")}[toTitle(t)],o=s?__(s):"",d=function(){frappe.model.get_all_docs(e.doc).filter(function(e){return frappe.model.is_table(e.doctype)}).map(function(e){(function(t){for(var i=0;i<t.length;i++)if(locals[e.doctype][e.name][t[i].fieldname])return!1;return!0})((frappe.meta.docfield_list[e.doctype]||[]).filter(function(e){return 1===cint(e.in_list_view)}))&&frappe.model.clear_doc(e.doctype,e.name)})},c=function(){var t=!1;return e.scroll_set=!1,2==e.doc.docstatus||($.each(frappe.model.get_all_docs(e.doc),function(i,a){var r=[],n=!1;if($.each(frappe.meta.docfield_list[a.doctype]||[],function(i,s){if(s.fieldname){var o=frappe.meta.get_docfield(a.doctype,s.fieldname,e.doc.name);"Fold"===o.fieldtype&&(n=e.layout.folded),o.reqd&&!frappe.model.has_value(a.doctype,a.name,o.fieldname)&&(t=!0,r[r.length]=__(o.label),e.scroll_set||l(a.parentfield||o.fieldname),n&&(e.layout.unfold(),n=!1))}}),r.length){if(a.parenttype)var s=__("Mandatory fields required in table {0}, Row {1}",[__(frappe.meta.docfield_map[a.parenttype][a.parentfield].label).bold(),a.idx]);else s=__("Mandatory fields required in {0}",[__(a.doctype)]);s=s+"<br><br><ul><li>"+r.join("</li><li>")+"</ul>",frappe.msgprint({message:s,indicator:"red",title:__("Missing Fields")})}}),!t)},l=function(t){var i=cur_frm.fields_dict[t];i&&$(document).scrollTop($(i.wrapper).offset().top-60),e.scroll_set=!0},p=function(e){if(frappe.ui.form.is_saving)throw console.log("Already saving. Please wait a few moments."),"saving";return frappe.ui.form.remove_old_form_route(),frappe.ui.form.is_saving=!0,frappe.call({freeze:!0,method:e.method,args:e.args,btn:e.btn,callback:function(t){e.callback&&e.callback(t)},error:e.error,always:function(e){if($(a).prop("disabled",!1),frappe.ui.form.is_saving=!1,e){var t=e.docs&&e.docs[0];t&&frappe.ui.form.update_calling_link(t)}}})};"cancel"===t?(r={doctype:e.doc.doctype,name:e.doc.name},(n=frappe.workflow.get_state_fieldname(e.doctype))&&$.extend(r,{workflow_state_fieldname:n,workflow_state:e.doc[n]}),p({method:"frappe.desk.form.save.cancel",args:r,callback:function(t){$(document).trigger("save",[e.doc]),i(t)},btn:a,freeze_message:o})):(d(),$(e.wrapper).addClass("validated-form"),c()?p({method:"frappe.desk.form.save.savedocs",args:{doc:e.doc,action:t},callback:function(t){$(document).trigger("save",[e.doc]),i(t)},error:function(e){i(e)},btn:a,freeze_message:o}):$(a).prop("disabled",!1))},frappe.ui.form.remove_old_form_route=function(){var e=-1,t=frappe.get_route();frappe.route_history.map(function(i,a){i.join("/")===t.join("/")&&(e=a)}),frappe.route_history.splice(e,1)},frappe.ui.form.update_calling_link=function(e){if(frappe._from_link&&e.doctype===frappe._from_link.df.options){var t=frappe.get_doc(frappe._from_link.doctype,frappe._from_link.docname);t&&t.parentfield?$.each(frappe._from_link.frm.fields_dict[t.parentfield].grid.grid_rows,function(t,i){i.doc&&i.doc.name===frappe._from_link.docname&&frappe._from_link.set_value(e.name)}):frappe._from_link.set_value(e.name),frappe._from_link.refresh(),frappe._from_link.frm&&frappe.set_route("Form",frappe._from_link.frm.doctype,frappe._from_link.frm.docname).then(function(){frappe.utils.scroll_to(frappe._from_link_scrollY)}),frappe._from_link=null}},frappe.provide("frappe.ui.form.handlers"),frappe.ui.form.get_event_handler_list=function(e,t){return frappe.ui.form.handlers[e]||(frappe.ui.form.handlers[e]={}),frappe.ui.form.handlers[e][t]||(frappe.ui.form.handlers[e][t]=[]),frappe.ui.form.handlers[e][t]},frappe.ui.form.on=frappe.ui.form.on_change=function(e,t,i){var a=function(t,i){frappe.ui.form.get_event_handler_list(e,t).push(i),cur_frm&&cur_frm.doctype===e&&(cur_frm.events[t]=i)};if(!i&&$.isPlainObject(t))for(var r in t){var n=t[r];"function"==typeof n&&a(r,n)}else a(t,i)},frappe.ui.form.off=function(e,t,i){frappe.ui.form.get_event_handler_list(e,t).length&&(frappe.ui.form.handlers[e][t]=[]),cur_frm&&cur_frm.doctype===e&&cur_frm.events[t]&&delete cur_frm.events[t],cur_frm&&cur_frm.cscript&&cur_frm.cscript[t]&&delete cur_frm.cscript[t]},frappe.ui.form.trigger=function(e,t){cur_frm.script_manager.trigger(t,e)},frappe.ui.form.ScriptManager=Class.extend({init:function(e){$.extend(this,e)},make:function(e){this.frm.cscript=$.extend(this.frm.cscript,new e({frm:this.frm}))},trigger:function(e,t,i){var a=this;t=t||this.frm.doctype,i=i||this.frm.docname;var r=[],n=this.get_handlers(e,t);this.frm.selected_doc=frappe.get_doc(t,i);var s=function(e,r){var n=null;return(n=r?a.frm.cscript[e](a.frm.doc,t,i):e(a.frm,t,i))&&n.then?n:frappe.after_server_call()};return n.new_style.forEach(function(t){"setup"===e?s(t,!1):r.push(function(){return s(t,!1)})}),n.old_style.forEach(function(t){"setup"===e?s(t,!0):r.push(function(){return s(t,!0)})}),frappe.run_serially(r)},has_handlers:function(e,t){var i=this.get_handlers(e,t);return i&&(i.old_style.length||i.new_style.length)},get_handlers:function(e,t){var i={old_style:[],new_style:[]};return frappe.ui.form.handlers[t]&&frappe.ui.form.handlers[t][e]&&$.each(frappe.ui.form.handlers[t][e],function(e,t){i.new_style.push(t)}),this.frm.cscript[e]&&i.old_style.push(e),this.frm.cscript["custom_"+e]&&i.old_style.push("custom_"+e),i},setup:function(){var doctype=this.frm.meta,me=this,cs=doctype.__js;if(cs)var tmp=eval(cs);if(doctype.__custom_js)try{eval(doctype.__custom_js)}catch(e){frappe.msgprint({title:__("Error in Custom Script"),indicator:"orange",message:'<pre class="small"><code>'+e.stack+"</code></pre>"})}function setup_add_fetch(e){if((["Data","Read Only","Text","Small Text","Currency","Text Editor","Code","Link","Float","Int","Date"].includes(e.fieldtype)||1==e.read_only)&&e.fetch_from&&-1!=e.fetch_from.indexOf(".")){var t=e.fetch_from.split(".");me.frm.add_fetch(t[0],t[1],e.fieldname)}}$.each(this.frm.fields,function(e,t){setup_add_fetch(t.df),"Table"===t.df.fieldtype&&$.each(frappe.meta.get_docfields(t.df.options,me.frm.docname),function(e,t){setup_add_fetch(t)})}),doctype.__css&&frappe.dom.set_style(doctype.__css),this.trigger("setup")},log_error:function(e,t){frappe.show_alert("Error in Client Script."),console.group&&console.group(),console.log("----- error in client script -----"),console.log("method: "+e),console.log(t),console.log("error message: "+t.message),console.trace&&console.trace(),console.log("----- end of error message -----"),console.group&&console.groupEnd()},copy_from_first_row:function(e,t,i){var a=this.frm.doc[e];1!==a.length&&a[0]!==t&&("string"==typeof i&&(i=[i]),$.each(i,function(e,i){frappe.model.set_value(t.doctype,t.name,i,a[0][i])}))}}),frappe.provide("frappe.ui.form"),frappe.ui.form.LinkedWith=class{constructor(e){$.extend(this,e)}show(){this.dialog||this.make_dialog(),$(this.dialog.body).html('<div class="text-muted text-center" style="padding: 30px 0px">\n\t\t\t\t'+__("Loading")+"...\n\t\t\t</div>"),this.dialog.show()}make_dialog(){var e=this;this.dialog=new frappe.ui.Dialog({hide_on_page_refresh:!0,title:__("Linked With")}),this.dialog.on_page_show=function(){e.get_linked_doctypes().then(function(){return e.load_doctypes()}).then(function(){return e.links_not_permitted_or_missing()}).then(function(){return e.get_linked_docs()}).then(function(){return e.make_html()})}}make_html(){var e=this,t=this.frm.__linked_docs,i="",a=Object.keys(t);i=0===a.length?__("Not Linked to any record"):a.map(function(i){var a=t[i];return'\n\t\t\t\t\t<div class="list-item-table margin-bottom">\n\t\t\t\t\t\t'+e.make_doc_head(i)+"\n\t\t\t\t\t\t"+a.map(function(t){return e.make_doc_row(t,i)}).join("")+"\n\t\t\t\t\t</div>\n\t\t\t\t"}).join(""),$(this.dialog.body).html(i)}load_doctypes(){var e=this,t=Object.keys(locals.DocType),i=[];this.frm.__linked_doctypes&&(i=Object.keys(this.frm.__linked_doctypes).filter(function(e){return!t.includes(e)}));var a=i.map(function(t){return frappe.model.with_doctype(t,function(){frappe.listview_settings[t]&&(e.frm.__linked_doctypes[t].add_fields=frappe.listview_settings[t].add_fields)})});return Promise.all(a)}links_not_permitted_or_missing(){var e,t=null;return this.frm.__linked_doctypes&&(t=Object.keys(this.frm.__linked_doctypes).filter(frappe.model.can_get_report)),t||($(this.dialog.body).html(""+(this.frm.__linked_doctypes?__("Not enough permission to see links"):__("Not Linked to any record"))),e=!0),e=!1,new Promise(function(t,i){return e?i():t()})}get_linked_doctypes(){var e=this;return new Promise(function(t){e.frm.__linked_doctypes&&t(),frappe.call({method:"frappe.desk.form.linked_with.get_linked_doctypes",args:{doctype:e.frm.doctype},callback:function(i){e.frm.__linked_doctypes=i.message,t()}})})}get_linked_docs(){var e=this;return frappe.call({method:"frappe.desk.form.linked_with.get_linked_docs",args:{doctype:this.frm.doctype,name:this.frm.docname,linkinfo:this.frm.__linked_doctypes,for_doctype:this.for_doctype},callback:function(t){e.frm.__linked_docs=t.message||{}}})}make_doc_head(e){return'\n\t\t\t<header class="level list-row list-row-head text-muted small">\n\t\t\t\t<div>'+__(e)+"</div>\n\t\t\t</header>\n\t\t"}make_doc_row(e,t){return'<div class="list-row-container">\n\t\t\t<div class="level list-row small">\n\t\t\t\t<div class="level-left bold">\n\t\t\t\t\t<a href="#Form/'+t+"/"+e.name+'">'+e.name+"</a>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>"}},frappe.ui.form.States=Class.extend({init:function(e){if($.extend(this,e),this.state_fieldname=frappe.workflow.get_state_fieldname(this.frm.doctype),this.state_fieldname){this.update_fields=frappe.workflow.get_update_fields(this.frm.doctype);var t=this;$(this.frm.wrapper).bind("render_complete",function(){t.refresh()})}},setup_help:function(){var e=this;this.frm.page.add_action_item(__("Help"),function(){frappe.workflow.setup(e.frm.doctype);var t=e.get_state(),i=new frappe.ui.Dialog({title:"Workflow: "+frappe.workflow.workflows[e.frm.doctype].name});frappe.workflow.get_transitions(e.frm.doc).then(function(a){var r=$.map(a,function(e){return e.action.bold()+__(" by Role ")+e.allowed}).join(", ")||__("None: End of Workflow").bold();$(i.body).html("<p>"+__("Current status")+": "+t.bold()+"</p><p>"+__("Document is only editable by users of role")+": "+frappe.workflow.get_document_state(e.frm.doctype,t).allow_edit.bold()+"</p><p>"+__("Next actions")+": "+r+"</p>"+(e.frm.doc.__islocal?"<div class='alert alert-info'>"+__("Workflow will start after saving.")+"</div>":"")+"<p class='help'>"+__("Note: Other permission rules may also apply")+"</p>").css({padding:"15px"}),i.show()})},!0)},refresh:function(){if(this.frm.doc.__islocal)this.set_default_state();else{var e=this.get_state();this.frm.doctype;e&&this.show_actions(e)}},show_actions:function(){var e=this,t=!1,i=this;this.frm.page.clear_actions_menu(),1!==this.frm.doc.__unsaved&&frappe.workflow.get_transitions(this.frm.doc).then(function(a){$.each(a,function(e,a){var r,n,s;frappe.user_roles.includes(a.allowed)&&(r=a,n=!1,("Administrator"===(s=frappe.session.user)||r.allow_self_approval||s!==i.frm.doc.owner)&&(n=!0),n)&&(t=!0,i.frm.page.add_action_item(__(a.action),function(){frappe.xcall("frappe.model.workflow.apply_workflow",{doc:i.frm.doc,action:a.action}).then(function(e){frappe.model.sync(e),i.frm.refresh()})}))}),e.setup_btn(t)})},setup_btn:function(e){e&&(this.frm.page.btn_primary.addClass("hide"),this.frm.page.btn_secondary.addClass("hide"),this.frm.toolbar.current_status="",this.setup_help())},set_default_state:function(){var e=frappe.workflow.get_default_state(this.frm.doctype,this.frm.doc.docstatus);e&&this.frm.set_value(this.state_fieldname,e)},get_state:function(){return this.frm.doc[this.state_fieldname]||this.set_default_state(),this.frm.doc[this.state_fieldname]}}),frappe.provide("frappe.ui.form"),frappe.ui.form.PrintPreview=Class.extend({init:function(e){$.extend(this,e),this.make(),this.bind_events()},make:function(){this.wrapper=this.frm.page.add_view("print",frappe.render_template("print_layout",{})),this.wrapper.find(".btn-print-edit").toggle(frappe.user.has_role("System Manager"))},bind_events:function(){var e=this;this.wrapper.find(".btn-print-close").click(function(){e.frm.hide_print()}),$(document).on("keydown",function(t){27===t.which&&e.frm&&t.target===document.body&&e.frm.hide_print()}),this.print_formats=frappe.meta.get_print_formats(this.frm.meta.name),this.print_letterhead=this.wrapper.find(".print-letterhead").on("change",function(){e.print_sel.trigger("change")}).prop("checked",!!cint((frappe.model.get_doc(":Print Settings","Print Settings")||{with_letterhead:1}).with_letterhead)),this.print_sel=this.wrapper.find(".print-preview-select").on("change",function(){e.set_default_print_language(),e.multilingual_preview()}),this.language_sel=this.wrapper.find(".languages").on("change",function(){e.lang_code=e.language_sel.val(),e.multilingual_preview()}),this.wrapper.find(".btn-print-print").click(function(){e.is_old_style()?e.print_old_style():e.printit()}),this.wrapper.find(".btn-print-preview").click(function(){e.is_old_style()?e.new_page_preview_old_style():e.new_page_preview()}),this.wrapper.find(".btn-download-pdf").click(function(){if(!e.is_old_style()&&!window.open(frappe.urllib.get_full_url("/api/method/frappe.utils.print_format.download_pdf?doctype="+encodeURIComponent(e.frm.doc.doctype)+"&name="+encodeURIComponent(e.frm.doc.name)+"&format="+e.selected_format()+"&no_letterhead="+(e.with_letterhead()?"0":"1")+(e.lang_code?"&_lang="+e.lang_code:""))))return void frappe.msgprint(__("Please enable pop-ups"))}),this.wrapper.find(".btn-print-edit").on("click",function(){var t=e.get_print_format();t&&t.name?t.print_format_builder?frappe.set_route("print-format-builder",t.name):frappe.set_route("Form","Print Format",t.name):frappe.prompt({fieldname:"print_format_name",fieldtype:"Data",reqd:1,label:"New Print Format Name"},function(t){frappe.route_options={make_new:!0,doctype:e.frm.doctype,name:t.print_format_name},frappe.set_route("print-format-builder")},__("New Custom Print Format"),__("Start"))})},set_user_lang:function(){this.lang_code=this.frm.doc.language,this.language_sel.empty().add_options([{value:"",label:__("Select Language...")}].concat(frappe.get_languages())).val(this.lang_code),this.preview()},set_default_print_language:function(){var e=this.get_print_format();e.default_print_language?(this.lang_code=e.default_print_language,this.language_sel.val(this.lang_code)):this.language_sel.val(frappe.boot.lang)},multilingual_preview:function(){var e=this;this.is_old_style()?(e.wrapper.find(".btn-download-pdf").toggle(!1),e.set_style(),e.preview_old_style()):(e.wrapper.find(".btn-download-pdf").toggle(!0),e.preview())},preview:function(){var e=this;this.get_print_html(function(t){var i=e.wrapper.find(".print-format");i.html(t.html),e.show_footer(),e.set_style(t.style);var a=i.get(0).offsetHeight,r=e.wrapper.find(".page-break-message");frappe.dom.pixel_to_inches(a)>11.69?r.text(__("This may get printed on multiple pages")):r.text("")})},show_footer:function(){this.wrapper.find(".print-format").css({display:"flex",flexDirection:"column"}),this.wrapper.find(".page-break").css({display:"flex","flex-direction":"column",flex:"1"}),this.wrapper.find("#footer-html").attr("style","\n\t\t\tdisplay: block !important;\n\t\t\torder: 1;\n\t\t\tmargin-top: auto;\n\t\t")},printit:function(){var e=this;frappe.call({method:"frappe.printing.doctype.print_settings.print_settings.is_print_server_enabled",callback:function(t){t.message?frappe.call({method:"frappe.utils.print_format.print_by_server",args:{doctype:e.frm.doc.doctype,name:e.frm.doc.name,print_format:e.selected_format(),no_letterhead:e.with_letterhead()},callback:function(e){}}):e.new_page_preview(!0)}})},new_page_preview:function(e){var t=this;window.open(frappe.urllib.get_full_url("/printview?doctype="+encodeURIComponent(t.frm.doc.doctype)+"&name="+encodeURIComponent(t.frm.doc.name)+(e?"&trigger_print=1":"")+"&format="+t.selected_format()+"&no_letterhead="+(t.with_letterhead()?"0":"1")+(t.lang_code?"&_lang="+t.lang_code:"")))||frappe.msgprint(__("Please enable pop-ups"))},get_print_html:function(e){frappe.call({method:"frappe.www.printview.get_html_and_style",args:{doc:this.frm.doc,print_format:this.selected_format(),no_letterhead:this.with_letterhead()?0:1,_lang:this.lang_code},callback:function(t){t.exc||e(t.message)}})},preview_old_style:function(){var e=this;this.with_old_style({format:e.print_sel.val(),callback:function(t){e.wrapper.find(".print-format").html('<div class="alert alert-warning">'+__("Warning: This Print Format is in old style and cannot be generated via the API.")+"</div>"+t)},no_letterhead:!this.with_letterhead(),only_body:!0,no_heading:!0})},refresh_print_options:function(){return this.print_formats=frappe.meta.get_print_formats(this.frm.doctype),this.print_sel.empty().add_options(this.print_formats)},with_old_style:function(e){frappe.require("/assets/js/print_format_v3.min.js",function(){_p.build(e.format,e.callback,e.no_letterhead,e.only_body,e.no_heading)})},print_old_style:function(){var e=this;frappe.require("/assets/js/print_format_v3.min.js",function(){_p.build(e.print_sel.val(),_p.go,!e.with_letterhead())})},new_page_preview_old_style:function(){var e=this;frappe.require("/assets/js/print_format_v3.min.js",function(){_p.build(e.print_sel.val(),_p.preview,!e.with_letterhead())})},selected_format:function(){return this.print_sel.val()||this.frm.meta.default_print_format||"Standard"},is_old_style:function(e){return"Client"===this.get_print_format(e).print_format_type},get_print_format:function(e){return e||(e=this.selected_format()),locals["Print Format"]&&locals["Print Format"][e]?locals["Print Format"][e]:{}},with_letterhead:function(){return this.print_letterhead.is(":checked")?1:0},set_style:function(e){frappe.dom.set_style(e||frappe.boot.print_css,"print-style")}}),frappe.ui.get_print_settings=function(e,t,i){var a=locals[":Print Settings"]["Print Settings"],r=locals[":Company"]&&frappe.defaults.get_default("company")?locals[":Company"][frappe.defaults.get_default("company")].default_letter_head:"",n=[{fieldtype:"Check",fieldname:"with_letter_head",label:__("With Letter head")},{fieldtype:"Select",fieldname:"letter_head",label:__("Letter Head"),depends_on:"with_letter_head",options:$.map(frappe.boot.letter_heads,function(e,t){return t}),default:i||r},{fieldtype:"Select",fieldname:"orientation",label:__("Orientation"),options:"Landscape\nPortrait",default:"Landscape"}];frappe.prompt(n,function(e){(e=$.extend(a,e)).with_letter_head||(e.letter_head=null),e.letter_head&&(e.letter_head=frappe.boot.letter_heads[a.letter_head]),t(e)},__("Print Settings"))},frappe.provide("frappe.ui.form"),frappe.ui.form.Sidebar=Class.extend({init:function(e){$.extend(this,e)},make:function(){var e=frappe.render_template("form_sidebar",{doctype:this.frm.doctype,frm:this.frm});this.sidebar=$('<div class="form-sidebar overlay-sidebar hidden-xs hidden-sm"></div>').html(e).appendTo(this.page.sidebar.empty()),this.ratings=this.sidebar.find(".sidebar-rating"),this.comments=this.sidebar.find(".sidebar-comments"),this.user_actions=this.sidebar.find(".user-actions"),this.image_section=this.sidebar.find(".sidebar-image-section"),this.image_wrapper=this.image_section.find(".sidebar-image-wrapper"),this.make_assignments(),this.make_attachments(),this.make_shared(),this.make_viewers(),this.make_tags(),this.make_like(),this.bind_events(),frappe.ui.form.setup_user_image_event(this.frm),this.refresh()},bind_events:function(){var e=this;this.comments.on("click",function(){frappe.utils.scroll_to(e.frm.footer.wrapper.find(".form-comments"),!0)}),this.like_icon.on("click",function(){frappe.ui.toggle_like(e.like_icon,e.frm.doctype,e.frm.doc.name,function(){e.refresh_like()})})},refresh:function(){this.frm.doc.__islocal?this.sidebar.toggle(!1):(this.sidebar.toggle(!0),this.frm.assign_to.refresh(),this.frm.attachments.refresh(),this.frm.shared.refresh(),this.frm.viewers.refresh(),this.frm.tags&&this.frm.tags.refresh(this.frm.doc._user_tags),this.sidebar.find(".modified-by").html(__("{0} edited this {1}",["<strong>"+frappe.user.full_name(this.frm.doc.modified_by)+"</strong>","<br>"+comment_when(this.frm.doc.modified)])),this.sidebar.find(".created-by").html(__("{0} created this {1}",["<strong>"+frappe.user.full_name(this.frm.doc.owner)+"</strong>","<br>"+comment_when(this.frm.doc.creation)])),this.refresh_like(),this.setup_ratings(),frappe.ui.form.set_user_image(this.frm))},refresh_comments:function(){$.map(this.frm.timeline.get_communications(),function(e){return"Communication"===e.communication_type||"Comment"==e.communication_type&&"Comment"===e.comment_type?e:null}),this.comments.find(".n-comments").html(this.frm.get_docinfo().total_comments)},make_tags:function(){var e=this;this.frm.meta.issingle?this.sidebar.find(".form-tags").toggle(!1):this.frm.tags=new frappe.ui.TagEditor({parent:this.sidebar.find(".tag-area"),frm:this.frm,on_change:function(t){e.frm.doc._user_tags=t}})},make_attachments:function(){this.frm.attachments=new frappe.ui.form.Attachments({parent:this.sidebar.find(".form-attachments"),frm:this.frm})},make_assignments:function(){this.frm.assign_to=new frappe.ui.form.AssignTo({parent:this.sidebar.find(".form-assignments"),frm:this.frm})},make_shared:function(){this.frm.shared=new frappe.ui.form.Share({frm:this.frm,parent:this.sidebar.find(".form-shared")})},make_viewers:function(){this.frm.viewers=new frappe.ui.form.Viewers({frm:this.frm,parent:this.sidebar.find(".form-viewers")})},add_user_action:function(e,t){return $("<a>").html(e).appendTo($('<li class="user-action-row">').appendTo(this.user_actions.removeClass("hidden"))).on("click",t)},clear_user_actions:function(){this.user_actions.addClass("hidden"),this.user_actions.find(".user-action-row").remove()},make_like:function(){this.like_wrapper=this.sidebar.find(".liked-by"),this.like_icon=this.sidebar.find(".liked-by .octicon-heart"),this.like_count=this.sidebar.find(".liked-by .likes-count"),frappe.ui.setup_like_popover(this.sidebar.find(".liked-by-parent"),".liked-by")},refresh_like:function(){this.like_icon&&(this.like_wrapper.attr("data-liked-by",this.frm.doc._liked_by),this.like_icon.toggleClass("text-extra-muted not-liked",!frappe.ui.is_liked(this.frm.doc)).attr("data-doctype",this.frm.doctype).attr("data-name",this.frm.doc.name),this.like_count.text(JSON.parse(this.frm.doc._liked_by||"[]").length))},refresh_image:function(){},setup_ratings:function(){var e=this.frm.get_docinfo().rating||0;if(e){this.ratings.removeClass("hide");var t=frappe.render_template("rating_icons",{rating:e,show_label:!1});this.ratings.find(".rating-icons").html(t)}}}),frappe.ui.form.set_user_image=function(e){var t=e.sidebar.image_section,i=e.meta.image_field,a=e.doc[i],r=e.page.$title_area.find(".title-image");if(t.toggleClass("hide",!i),r.toggleClass("hide",!i),i)if(a)a=window.cordova&&-1===a.indexOf("http")?frappe.base_url+a:a,t.find(".sidebar-image").css("background-image",'url("'+a+'")').removeClass("hide"),t.find(".sidebar-standard-image").addClass("hide"),r.css("background-color","").css("background-image",'url("'+a+'")').html("");else{t.find(".sidebar-image").css("background-image",null).addClass("hide");var n=e.get_title();t.find(".sidebar-standard-image").removeClass("hide").find(".standard-image").css({"background-color":frappe.get_palette(n)}).html(frappe.get_abbr(n)),r.css("background-image","").css({"background-color":frappe.get_palette(n)}).html(frappe.get_abbr(n))}},frappe.ui.form.setup_user_image_event=function(e){e.meta.image_field&&frappe.ui.form.on(e.doctype,e.meta.image_field,function(e){frappe.ui.form.set_user_image(e)}),e.sidebar.image_wrapper.on("click",function(){var t=e.get_field(e.meta.image_field);t.$input||t.make_input(),t.$input.trigger("click")})},frappe.provide("frappe.ui.form"),frappe.ui.form.Share=Class.extend({init:function(e){$.extend(this,e)},refresh:function(){this.render_sidebar()},render_sidebar:function(){var e=this;this.parent.empty();for(var t=this.shared||this.frm.get_docinfo().shared,i=[],a=0,r=(t=t.filter(function(e){return e})).length;a<r;a++){var n=t[a];if(n.everyone)i.push({icon:"octicon octicon-megaphone text-muted",avatar_class:"avatar-empty share-doc-btn shared-with-everyone",title:__("Shared with everyone")});else{var s=frappe.user_info(n.user);i.push({image:s.image,fullname:s.fullname,abbr:s.abbr,color:s.color,title:__("Shared with {0}",[s.fullname])})}}e.frm.doc.__islocal||i.push({icon:"octicon octicon-plus text-muted",avatar_class:"avatar-empty share-doc-btn",title:__("Share")}),this.parent.append(frappe.render_template("users_in_sidebar",{users:i})),this.parent.find(".avatar").on("click",function(){e.frm.share_doc()})},show:function(){var e=this,t=new frappe.ui.Dialog({title:__("Share {0} with",[this.frm.doc.name])});this.dialog=t,this.dirty=!1,frappe.call({method:"frappe.share.get_users",args:{doctype:this.frm.doctype,name:this.frm.doc.name},callback:function(t){e.render_shared(t.message||[])}}),$(t.body).html('<p class="text-muted">'+__("Loading...")+"</p>"),t.onhide=function(){e.dirty&&e.frm.reload_docinfo()},t.show()},render_shared:function(e){e&&(this.shared=e);var t=this.dialog;$(t.body).empty();var i={};$.each(this.shared,function(e,t){t&&t.everyone&&(i=t)}),$(frappe.render_template("set_sharing",{frm:this.frm,shared:this.shared,everyone:i})).appendTo(t.body),frappe.model.can_share(null,this.frm)?(this.make_user_input(),this.add_share_button(),this.set_edit_share_events()):$(t.body).find(".edit-share").prop("disabled",!0)},make_user_input:function(){this.dialog.share_with=frappe.ui.form.make_control({parent:$(this.dialog.body).find(".input-wrapper-add-share"),df:{fieldtype:"Link",label:__("Share With"),fieldname:"share_with",options:"User",filters:{user_type:"System User",name:["!=",frappe.session.user]}},only_input:!0,render_input:!0})},add_share_button:function(){var e=this,t=this.dialog;$(t.body).find(".btn-add-share").on("click",function(){var i=t.share_with.get_value();i&&frappe.call({method:"frappe.share.add",args:{doctype:e.frm.doctype,name:e.frm.doc.name,user:i,read:$(t.body).find(".add-share-read").prop("checked")?1:0,write:$(t.body).find(".add-share-write").prop("checked")?1:0,share:$(t.body).find(".add-share-share").prop("checked")?1:0,notify:$(t.body).find(".add-share-notify").prop("checked")?1:0},btn:this,callback:function(t){$.each(e.shared,function(i,a){a&&a.user===t.message.user&&delete e.shared[i]}),e.dirty=!0,e.shared.push(t.message),e.render_shared(),e.frm.shared.refresh()}})})},set_edit_share_events:function(){var e=this,t=this.dialog;$(t.body).find(".edit-share").on("click",function(){var t=$(this).parents(".shared-user:first").attr("data-user")||"",i=$(this).prop("checked")?1:0,a=$(this).attr("name"),r=cint($(this).parents(".shared-user:first").attr("data-everyone"));frappe.call({method:"frappe.share.set_permission",args:{doctype:e.frm.doctype,name:e.frm.doc.name,user:t,permission_to:a,value:i,everyone:r},callback:function(i){var a=null;$.each(e.shared,function(n,s){if(s&&(s.user===t||r&&1===s.everyone))return i.message?e.shared[n]=$.extend(s,i.message):delete e.shared[n],a=!0,!1}),a||e.shared.push(i.message),e.dirty=!0,e.render_shared(),e.frm.shared.refresh()}})})}}),frappe.provide("frappe.ui.form"),frappe.ui.form.Viewers=Class.extend({init:function(e){$.extend(this,e)},get_viewers:function(){var e=this.frm.get_docinfo();return e&&e.viewers||{}},refresh:function(e){this.parent.empty();for(var t=this.get_viewers(),i=[],a=[],r=0,n=(t.current||[]).length;r<n;r++){var s=t.current[r];if(s!==frappe.session.user){var o=frappe.user_info(s);i.push({image:o.image,fullname:o.fullname,abbr:o.abbr,color:o.color,title:__("{0} is currently viewing this document",[o.fullname])}),-1!==t.new.indexOf(s)&&a.push(o.fullname)}}i.length?(this.parent.parent().removeClass("hidden"),this.parent.append(frappe.render_template("users_in_sidebar",{users:i}))):this.parent.parent().addClass("hidden"),e&&a.length&&(1===a.length?frappe.show_alert(__("{0} is currently viewing this document",[a[0]])):frappe.show_alert(__("{0} are currently viewing this document",[frappe.utils.comma_and(a)])))}}),frappe.ui.form.set_viewers=function(e){var t=e.doctype,i=e.docname,a=frappe.model.get_docinfo(t,i),r=(a&&a.viewers||{}).past||[],n=e.viewers||[],s=n.filter(function(e){return!r.includes(e)});frappe.model.set_docinfo(t,i,"viewers",{past:r.concat(s),new:s,current:n}),cur_frm&&cur_frm.doc&&cur_frm.doc.doctype===t&&cur_frm.doc.name==i&&cur_frm.viewers.refresh(!0)},frappe.templates.attachment='<li class="attachment-row">  <a class="close">&times;</a>  <a href="{{ file_path }}">   <i class="{{ icon }} fa-fw text-warning"></i>  </a>  <a href="{{ file_url }}" target="_blank" title="{{ file_name }}" class="ellipsis" style="max-width: calc(100% - 43px);">   <span>{{ file_name }}</span>  </a> </li>  ',frappe.templates.form_footer='<div class="form-footer">  <div class="after-save">   <div class="form-comments"></div>  </div>  <div class="pull-right scroll-to-top">   <a onclick="frappe.utils.scroll_to(0)"><i class="fa fa-chevron-up text-muted"></i></a>  </div> </div> ',frappe.templates.timeline='<div class="timeline">  <div class="timeline-head">  </div>  <div class="timeline-new-email">   {% if (doctype === "Communication") { %}    <button class="btn btn-default btn-reply-email btn-xs">     {%= __("Reply") %}    </button>   {% } else { %}    <button class="btn btn-default btn-new-email btn-xs">    {%= __("New Email") %}    </button>    {% if (allow_events_in_timeline===1) { %}    <button class="btn btn-default btn-new-interaction btn-xs">     {%= __("New Event") %}    </button>    {% } %}   {% } %}  </div>     <div class="timeline-items">      </div> </div> ',frappe.templates.timeline_item='<div class="media timeline-item {% if (data.user_content) { %} user-content {% } else { %} notification-content {% } %}" data-doctype="{{ data.doctype }}" data-name="{%= data.name %}" data-communication-type = "{{ data.communication_type }}">  {% if (data.user_content) { %}  <span class="pull-left avatar avatar-medium hidden-xs" style="margin-top: 1px">   {% if(data.user_info.image) { %}   <div class="avatar-frame" style="background-image: url(\'{%= data.user_info.image %}\')"></div>   {% } else { %}   <div class="standard-image" style="background-color: {{ data.user_info.color }}">    {{ data.user_info.abbr }}</div>   {% } %}  </span>  {% } %}   <div class="pull-left media-body">   <div class="media-content-wrapper">    <div class="action-btns">     {% if(data.delete) { %}     <div class="pull-right hidden-xs close-btn-container">      <span class="small text-muted">       {%= data.delete %}      </span>     </div>     {% } %}     {% if(data.edit) { %}     <div class="pull-right edit-btn-container">      <span class="small text-muted">       {%= data.edit %}      </span>     </div>     {% } %}    </div>    {% if(data.communication_type==="Communication"     || data.communication_type==="Feedback"     || (data.communication_type==="Comment"      && data.comment_type==="Comment")) { %}    <div class="comment-header clearfix small {% if (data.edit || data.delete) { %} links-active {% } %}">     <span class="pull-left avatar avatar-small visible-xs">      {% if(data.user_info.image) { %}      <div class="avatar-frame" style="background-image: url(\'{%= data.user_info.image %}\')"></div>      {% } else { %}      <div class="standard-image" style="background-color: {{ data.user_info.color }}">       {{ data.user_info.abbr }}</div>      {% } %}     </span>     <div class="asset-details" data-communication-type = "{{ data.communication_type }}">      <span class="author-wrap">       <i class="{%= data.icon %} hidden-xs fa-fw"></i>       <span title="{%= data.comment_by %}">{%= data.fullname %}</span>      </span>      <span>       {% if (data.timeline_doctype===data.frm.doc.doctype        && data.timeline_name===data.frm.doc.name) { %}        &ndash;        <a href="#Form/{%= data.reference_doctype %}/{%= data.reference_name %}" class="text-muted">         <strong>{{ __(data.reference_doctype) }}</strong>          {{ data.reference_name }}        </a>       {% } %}      </span>       {% if(in_list(["Communication", "Feedback"], data.communication_type)) { %}        {% if (frappe.model.can_read(\'Communication\')) { %}        <a href="#Form/Communication/{%= data.name %}"         class="text-muted">        {% } %}         {% if (data.delivery_status) {         if (in_list(["Sent", "Clicked"], data.delivery_status)) {          var indicator_class = "green";         } else if (data.delivery_status === "Sending") {          var indicator_class = "orange";         } else if (in_list(["Opened", "Read"], data.delivery_status)) {          var indicator_class = "blue";         } else {          var indicator_class = "red";         }        %}        <span class="text-muted hidden-xs">&ndash;</span>        <span class="indicator-right {%= indicator_class %}         delivery-status-indicator"         title="{%= data.delivery_status %}"><span class="hidden-xs">         {%= data.delivery_status %}</span></span>         {% } else { %}         {% if (frappe.model.can_read(\'Communication\')) { %}         <span class="text-muted n-dash">&ndash;</span>         {%= __("Details") %}         {% } %}        {% } %}         {% if (frappe.model.can_read(\'Communication\')) { %}        </a>        {% } %}         {% if (data.communication_medium === "Email"         && data.sender !== frappe.session.user_email) { %}        <a class="text-muted reply-link pull-right timeline-content-show"         data-name="{%= data.name %}" title="{%= __("Reply") %}">{%= __("Reply") %}</a>        {% } %}       {% } %}      <span class="text-muted commented-on hidden-xs {% if (data.futur_date) { %}timeline-futur{% } %}">       &ndash; {%= data.comment_on %}</span>      <span class="text-muted commented-on-small {% if (data.futur_date) { %}timeline-futur{% } %}">       &ndash; {%= data.comment_on_small %}</span>      <span class="comment-likes hidden-xs"       data-liked-by=\'{{ JSON.stringify(data._liked_by) }}\'>       <i class="octicon octicon-heart like-action        {% if (!data.liked_by_user) { %}         text-extra-muted not-liked        {% } %} fa-fw"        data-doctype="{%= data.doctype %}"        data-name="{%= data.name %}"></i>       <span class="likes-count text-muted">        {{ (data._liked_by || []).length }}</span>      </span>     </div>    </div>    <div class="reply timeline-content-show">     <div class="timeline-item-content">      {% if data.show_subject %}       <p class="text-muted small">        <b>{{ __("Title") }}:</b> {{ data.subject }}</p>       <hr>      {% endif %}       {% if data.communication_type == "Feedback" && data.rating_icons %}       <p class="text-muted small">{{ data.rating_icons }}</p>       <hr>      {% endif %}       {%= data.content_html %}     </div>     <div class="timeline-item-edit"></div>     {% if(data.attachments && data.attachments.length) { %}     <div style="margin: 10px 0px">      {% $.each(data.attachments, function(i, a) { %}      <div class="ellipsis">       <a href="{%= encodeURI(a.file_url).replace(/#/g, \'%23\') %}"        class="text-muted small" target="_blank" rel="noopener noreferrer">        <i class="fa fa-paperclip"></i>        {%= a.file_url.split("/").slice(-1)[0] %}        {% if (a.is_private) { %}        <i class="fa fa-lock text-warning"></i>        {% } %}       </a>      </div>      {% }); %}     </div>     {% } %}    </div>     {% } else if(in_list(["Assignment Completed", "Assigned", "Shared",     "Unshared"], data.comment_type)) { %}     <div class="small">      <i class="{%= data.icon %} fa-fw"></i>       {% if (data.timeline_doctype===data.frm.doc.doctype        && data.timeline_name===data.frm.doc.name) { %}        <a href="#Form/{%= data.reference_doctype %}/{%= data.reference_name %}">         <strong>{{ __(data.reference_doctype) }}</strong>          {{ data.reference_name }}        </a>        &ndash;       {% } %}       {% if(data.link_doctype && data.link_name) { %}       <a href="#Form/{%= data.link_doctype %}/{%= data.link_name %}">       {% } %}        {%= __(data.content) %}       {% if(data.link_doctype && data.link_name) { %}       </a>       {% } %}       <span class="text-muted commented-on" style="font-weight: normal;">       &ndash; {%= data.comment_on %}</span>     </div>    {% } else { %}     <div class="small">      <i class="{%= data.icon %} fa-fw"></i>      {% if (data.comment_type == "Like") { %}      <span title="{%= data.comment_by %}">       {% if (data.timeline_doctype===data.frm.doc.doctype        && data.timeline_name===data.frm.doc.name) { %}        <a href="#Form/{%= data.reference_doctype %}/{%= data.reference_name %}">         <strong>{{ __(data.reference_doctype) }}</strong>          {{ data.reference_name }}        </a> &ndash;       {% } %}       {%= __("Liked by {0}", [data.fullname]) %}      </span>      {% } else { %}       <b title="{{ data.comment_by }}">{%= data.fullname %}</b>       {%= __(data.content) %}       {% if (data.timeline_doctype===data.frm.doc.doctype        && data.timeline_name===data.frm.doc.name) { %}         &ndash;         <a href="#Form/{%= data.reference_doctype %}/{%= data.reference_name %}">         <strong>{{ __(data.reference_doctype) }}</strong>          {{ data.reference_name }}        </a>       {% } %}      {% } %}      <span class="text-muted commented-on" style="font-weight: normal;">      &ndash; {%= data.comment_on %}</span>     </div>    {% } %}   </div>  </div> </div> ',frappe.ui.form.Footer=Class.extend({init:function(e){var t=this;$.extend(this,e),this.make(),this.make_comments(),$(this.frm.wrapper).on("render_complete",function(){t.refresh()})},make:function(){var e=this;this.wrapper=$(frappe.render_template("form_footer",{})).appendTo(this.parent),this.wrapper.find(".btn-save").click(function(){e.frm.save("Save",null,this)})},make_comments:function(){this.frm.timeline=new frappe.ui.form.Timeline({parent:this.wrapper.find(".form-comments"),frm:this.frm})},refresh:function(){this.frm.doc.__islocal?this.parent.addClass("hide"):(this.parent.removeClass("hide"),this.frm.timeline.refresh())}}),frappe.provide("frappe.ui.form"),frappe.ui.form.Attachments=Class.extend({init:function(e){$.extend(this,e),this.make()},make:function(){var e=this;this.parent.find(".add-attachment").click(function(){e.new_attachment()}),this.add_attachment_wrapper=this.parent.find(".add_attachment").parent(),this.attachments_label=this.parent.find(".attachments-label")},max_reached:function(){return!(Object.keys(this.get_attachments()).length<this.frm.meta.max_attachments||!this.frm.meta.max_attachments)},refresh:function(){var e=this;if(this.frm.doc.__islocal)this.parent.toggle(!1);else{this.parent.toggle(!0),this.parent.find(".attachment-row").remove();var t=this.max_reached();this.add_attachment_wrapper.toggleClass("hide",!t);var i=this.get_attachments();i.length?i.forEach(function(t){e.add_attachment(t)}):this.attachments_label.removeClass("has-attachments")}},get_attachments:function(){return this.frm.get_docinfo().attachments},add_attachment:function(e){var t=e.file_name,i=this.get_file_url(e),a=e.name;t||(t=i);var r=this,n=$(frappe.render_template("attachment",{file_path:"/desk#Form/File/"+a,icon:e.is_private?"fa fa-lock":"fa fa-unlock-alt",file_name:t,file_url:frappe.urllib.get_full_url(i)})).insertAfter(this.attachments_label.addClass("has-attachments")).find(".close").data("fileid",a).click(function(){var e=this;return frappe.confirm(__("Are you sure you want to delete the attachment?"),function(){r.remove_attachment($(e).data("fileid"))}),!1});frappe.model.can_write(this.frm.doctype,this.frm.name)||n.remove()},get_file_url:function(e){var t=e.file_url;return t||(t=0===e.file_name.indexOf("files/")?"/"+e.file_name:"/files/"+e.file_name),encodeURI(t).replace(/#/g,"%23")},get_file_id_from_file_url:function(e){var t;return $.each(this.get_attachments(),function(i,a){if(a.file_url===e)return t=a.name,!1}),t},remove_attachment_by_filename:function(e,t){this.remove_attachment(this.get_file_id_from_file_url(e),t)},remove_attachment:function(e,t){if(e){var i=this;return frappe.call({method:"frappe.desk.form.utils.remove_attach",args:{fid:e,dt:i.frm.doctype,dn:i.frm.docname},callback:function(a,r){a.exc?a._server_messages||frappe.msgprint(__("There were errors")):(i.remove_fileid(e),i.frm.get_docinfo().communications.push(a.message),i.frm.timeline&&i.frm.timeline.refresh(),t&&t())}})}t&&t()},new_attachment:function(e){var t=this;this.dialog&&this.dialog.$wrapper.remove(),this.dialog=frappe.ui.get_upload_dialog({args:t.get_args(),callback:function(e,i){t.attachment_uploaded(e,i)},max_width:t.frm.cscript?t.frm.cscript.attachment_max_width:null,max_height:t.frm.cscript?t.frm.cscript.attachment_max_height:null})},get_args:function(){return{from_form:1,doctype:this.frm.doctype,docname:this.frm.docname}},attachment_uploaded:function(e,t){this.dialog&&this.dialog.hide(),this.update_attachment(e,t.message.comment),this.fieldname&&this.frm.set_value(this.fieldname,e.file_url)},update_attachment:function(e,t){e.name&&(this.add_to_attachments(e),this.refresh(),t&&(this.frm.get_docinfo().communications.push(t),this.frm.timeline.refresh()))},add_to_attachments:function(e){var t=this.get_attachments();for(var i in t)if(t[i].name===e.name)return;t.push(e)},remove_fileid:function(e){var t=this.get_attachments(),i=[];$.each(t,function(t,a){a.name!=e&&i.push(a)}),this.frm.get_docinfo().attachments=i,this.refresh()}}),frappe.ui.get_upload_dialog=function(e){var t=new frappe.ui.Dialog({title:__("Upload Attachment"),no_focus:!0,fields:[{fieldtype:"Section Break"},{fieldtype:"Link",fieldname:"file",label:__("Select uploaded file"),options:"File",onchange:function(){frappe.call({method:"frappe.client.get_value",args:{doctype:"File",fieldname:["file_url","file_name","is_private"],filters:{name:t.get_value("file")}},callback:function(i){i.message?(t.$wrapper.find('[name="file_url"]').val(i.message.file_url),t.$wrapper.find(".private-file input").prop("checked",i.message.is_private),e.args.filename=i.message.file_name,e.args.is_private=i.message.is_private):t.$wrapper.find('[name="file_url"]').val("")}})}},{hidden:!e.args.doctype||!frappe.boot.gsuite_enabled,fieldtype:"Section Break",label:__("GSuite Document")},{fieldtype:"Link",fieldname:"gs_template",label:__("Select template"),options:"GSuite Templates",reqd:!1,filters:{related_doctype:e.args.doctype},onchange:function(){e.args.gs_template=this.get_value()}}]}),i=t.set_primary_action(__("Attach"));i.removeClass("btn-primary").addClass("btn-default"),t.show();var a=$("<div></div>").prependTo(t.body);return frappe.upload.make({parent:a,args:e.args,callback:function(i,a){t.hide(),e.callback&&e.callback(i,a)},on_select:function(){i.removeClass("btn-default").addClass("btn-primary")},onerror:function(){t.hide()},btn:i,max_width:e.max_width,max_height:e.max_height}),t},frappe.provide("frappe.timeline"),frappe.separator_element="<div>---</div>",frappe.ui.form.Timeline=class{constructor(e){$.extend(this,e),this.make()}make(){var e=this,t=this;this.wrapper=$(frappe.render_template("timeline",{doctype:t.frm.doctype,allow_events_in_timeline:t.frm.meta.allow_events_in_timeline})).appendTo(t.parent),this.list=this.wrapper.find(".timeline-items"),this.comment_area=frappe.ui.form.make_control({parent:this.wrapper.find(".timeline-head"),df:{fieldtype:"Comment",fieldname:"comment",label:"Comment"},mentions:this.get_names_for_mentions(),render_input:!0,only_input:!0,on_submit:function(t){t&&e.insert_comment("Comment",t,e.comment_area.button)}}),this.setup_email_button(),this.setup_interaction_button(),this.list.on("click",".toggle-blockquote",function(){$(this).parent().siblings("blockquote").toggleClass("hidden")}),this.setup_comment_like(),this.list.on("click",".btn-more",function(){var e=t.get_communications();frappe.call({btn:this,method:"frappe.desk.form.load.get_communications",args:{doctype:t.frm.doc.doctype,name:t.frm.doc.name,start:e.length},callback:function(e){if(!e.exc){if(e.message){var i=e.message,a=t.get_communications().concat(i);frappe.model.set_docinfo(t.frm.doc.doctype,t.frm.doc.name,"communications",a),i.length<20&&(t.more=!1)}else t.more=!1;t.refresh()}}})})}setup_email_button(){var e=this,t="Communication"===this.frm.doctype?".btn-reply-email":".btn-new-email";this.email_button=this.wrapper.find(t).on("click",function(){var t=!0;$(this).is(".btn-new-email")&&(t=!1);var i={doc:e.frm.doc,frm:e.frm,recipients:e.get_recipient(),is_a_reply:t};if("Communication"===e.frm.doctype)$.extend(i,{txt:"",last_email:e.frm.doc,recipients:e.frm.doc.sender,subject:__("Re: {0}",[e.frm.doc.subject])});else{var a=frappe.markdown(e.comment_area.get_value());$.extend(i,{txt:strip_html(a)?a:""})}new frappe.views.CommunicationComposer(i)})}setup_interaction_button(){var e=this;this.activity_button=this.wrapper.find(".btn-new-interaction").on("click",function(){var t={doc:e.frm.doc,frm:e.frm,recipients:e.get_recipient()};$.extend(t,{txt:frappe.markdown(e.comment_area.get_value())}),new frappe.views.InteractionComposer(t)})}setup_editing_area(){this.$editing_area=$('<div class="timeline-editing-area">'),this.editing_area=new frappe.ui.CommentArea({parent:this.$editing_area,mentions:this.get_names_for_mentions(),no_wrapper:!0}),this.editing_area.destroy()}refresh(e){var t=this;if(this.last_type="Comment",this.frm.doc.__islocal)this.wrapper.toggle(!1);else{this.wrapper.toggle(!0),this.list.empty(),this.comment_area.set_value("");var i=this.get_communications(!0),a=this.get_view_logs(),r=i.concat(a);r.filter(function(e){return e.content}).sort(function(e,i){return t.compare_dates(e,i)}).forEach(function(e){e.frm=t.frm,t.render_timeline_item(e)}),void 0===this.more&&20===r.length&&(this.more=!0),this.more&&$('<div class="timeline-item">\t\t\t\t<button class="btn btn-default btn-xs btn-more">More</button>\t\t\t</div>').appendTo(t.list),t.render_timeline_item({content:__("created"),comment_type:"Created",communication_type:"Comment",sender:this.frm.doc.owner,communication_date:this.frm.doc.creation,creation:this.frm.doc.creation,frm:this.frm}),this.wrapper.find(".is-email").prop("checked","Email"===this.last_type).change(),this.frm.sidebar.refresh_comments(),this.frm.trigger("timeline_refresh")}}compare_dates(e,t){var i=e.communication_date?e.communication_date:e.creation,a=t.communication_date?t.communication_date:t.creation;return new Date(i)>new Date(a)?-1:1}make_editing_area(e){return frappe.ui.form.make_control({parent:e,df:{fieldtype:"Comment",fieldname:"comment",label:"Comment"},mentions:this.get_names_for_mentions(),render_input:!0,only_input:!0,no_wrapper:!0})}render_timeline_item(e){var t=this;this.prepare_timeline_item(e);var i=$(frappe.render_template("timeline_item",{data:e,frm:this.frm})).appendTo(t.list).on("click",".delete-comment",function(){var e=i.data("name");return t.delete_comment(e),!1}).on("click",".edit-comment",function(a){a.preventDefault();var r=i.data("name");if(i.hasClass("is-editing"))t.current_editing_area.submit();else{var n=$(this),s=i.find(".timeline-item-content"),o=i.find(".timeline-item-edit"),d=s.html();n.text(__("Save")).find("i").removeClass("octicon-pencil").addClass("octicon-check"),s.hide(),i.addClass("is-editing"),t.current_editing_area=t.make_editing_area(o),t.current_editing_area.set_value(d),t.current_editing_area.on_submit=function(i){o.empty(),s.show(),e.content=i,frappe.timeline.update_communication(e),t.update_comment(r,i),t.refresh()}}return!1});"Communication"==e.communication_type&&"Email"===e.communication_medium&&(this.last_type=e.communication_medium,this.add_reply_btn_event(i,e))}add_reply_btn_event(e,t){var i=this;e.find(".reply-link").on("click",function(){var e=$(this).attr("data-name"),t=null;i.get_communications().forEach(function(i){if(i.name==e)return t=i,!1}),new frappe.views.CommunicationComposer({doc:i.frm.doc,txt:"",title:__("Reply"),frm:i.frm,last_email:t,is_a_reply:!0})})}prepare_timeline_item(e){e.sender||(e.sender=e.owner||"Guest"),e.sender&&-1!==e.sender.indexOf("<")&&(e.sender=e.sender.split("<")[1].split(">")[0]),e.user_info=frappe.user_info(e.sender),e.delete="",e.edit="","Comment"==e.communication_type&&"Comment"===(e.comment_type||"Comment")&&(frappe.model.can_delete("Communication")&&(e.delete='<a class="close delete-comment" title="Delete"  href="#"><i class="octicon octicon-x"></i></a>'),frappe.user.name!=e.sender&&"Administrator"!=frappe.user.name||(e.edit='<a class="edit-comment text-muted" title="Edit" href="#">Edit</a>'));var t=e.communication_date||e.creation;e.comment_on_small=comment_when(t,!0),e.comment_on=comment_when(t),e.futur_date=t>frappe.datetime.now_datetime(),e.fullname||(e.fullname=e.sender_full_name||frappe.user.full_name(e.sender)),e.attachments&&"string"==typeof e.attachments&&(e.attachments=JSON.parse(e.attachments)),"Comment"!=e.communication_type||e.comment_type||(e.comment_type="Comment"),this.set_icon_and_color(e),"Workflow"===e.comment_type||"Label"===e.comment_type?e.comment_html=repl('<span class="label label-%(style)s">%(text)s</span>',{style:frappe.utils.guess_style(e.content),text:__(e.content)}):("Communication"==e.communication_type&&"Email"==e.communication_medium?(e.content=e.content.split(frappe.separator_element)[0],e.content=frappe.utils.strip_original_content(e.content),e.original_content=e.content,e.content=frappe.utils.toggle_blockquote(e.content)):"Feedback"===e.communication_type&&(e.content=frappe.utils.strip_original_content(e.content),e.original_content=e.content,e.content=frappe.utils.toggle_blockquote(e.content)),frappe.utils.is_html(e.content)?(e.content_html=e.content,e.content_html=frappe.utils.strip_whitespace(e.content_html)):e.content_html=frappe.markdown(__(e.content)),"Comment"!==e.comment_type||e.content_html.match(/(^|\W)<b>(@[^\s]+)<\/b>/)||(e.content_html=e.content_html.replace(/(<[a][^>]*>)/g,""),e.content_html=e.content_html.replace(/(@[^\s@]*)@[^\s@|<]*/g,"<b>$1</b>")),this.is_communication_or_comment(e)&&(e.user_content=!0,$.isArray(e._liked_by)||(e._liked_by=JSON.parse(e._liked_by||"[]")),e.liked_by_user=-1!==e._liked_by.indexOf(frappe.session.user))),e.content_html=frappe.dom.remove_script_and_style(e.content_html),e.show_subject=!1,e.subject&&"Communication"===e.communication_type&&(this.frm.doc.subject&&!this.frm.doc.subject.includes(e.subject)?e.show_subject=!0:this.frm.meta.title_field&&this.frm.doc[this.frm.meta.title_field]&&this.frm.doc[this.frm.meta.title_field].includes(e.subject)?e.show_subject=!0:this.frm.doc.name.includes(e.subject)||(e.show_subject=!0))}is_communication_or_comment(e){return"Communication"===e.communication_type||"Feedback"===e.communication_type||"Comment"===e.communication_type&&("Comment"===e.comment_type||"Relinked"===e.comment_type)}set_icon_and_color(e){"Feedback"==e.communication_type?(e.icon="octicon octicon-comment-discussion",e.rating_icons=frappe.render_template("rating_icons",{rating:e.rating,show_label:!0}),e.color="#f39c12"):(e.icon={Email:"octicon octicon-mail",Chat:"octicon octicon-comment-discussion",Phone:"octicon octicon-device-mobile",SMS:"octicon octicon-comment",Event:"fa fa-calendar",Meeting:"octicon octicon-briefcase",ToDo:"fa fa-check",Created:"octicon octicon-plus",Submitted:"octicon octicon-lock",Cancelled:"octicon octicon-x",Assigned:"octicon octicon-person","Assignment Completed":"octicon octicon-check",Comment:"octicon octicon-comment-discussion",Workflow:"octicon octicon-git-branch",Label:"octicon octicon-tag",Attachment:"octicon octicon-cloud-upload","Attachment Removed":"octicon octicon-trashcan",Shared:"octicon octicon-eye",Unshared:"octicon octicon-circle-slash",Like:"octicon octicon-heart",Edit:"octicon octicon-pencil",Relinked:"octicon octicon-check",Reply:"octicon octicon-mail-reply"}[e.comment_type||e.communication_medium],e.color={Email:"#3498db",Chat:"#3498db",Phone:"#3498db",SMS:"#3498db",Created:"#1abc9c",Submitted:"#1abc9c",Cancelled:"#c0392b",Assigned:"#f39c12","Assignment Completed":"#16a085",Comment:"#f39c12",Workflow:"#2c3e50",Label:"#2c3e50",Attachment:"#7f8c8d","Attachment Removed":"#eee",Relinked:"#16a085",Reply:"#8d99a6"}[e.comment_type||e.communication_medium],e.icon_fg={"Attachment Removed":"#333"}[e.comment_type||e.communication_medium]),e.icon_fg||(e.icon_fg="#fff")}get_communications(e){var t=this.frm.get_docinfo(),i=[].concat(t.communications);return e&&this.build_version_comments(t,i),i}get_view_logs(){for(var e=[],t=0,i=this.frm.get_docinfo().views;t<i.length;t+=1){var a=i[t];a.content='<a href="#Form/View Log/'+a.name+'"> '+__("viewed")+"</a>",a.comment_type="Info",e.push(a)}return e}build_version_comments(e,t){var i=this;e.versions.forEach(function(e){if(e.data){var a=JSON.parse(e.data);if(a.comment)t.push(i.get_version_comment(e,a.comment,a.comment_type));else{if(a.changed&&a.changed.length){var r=[];a.changed.every(function(a){if("docstatus"===a[0])1==a[2]?t.push(i.get_version_comment(e,__("submitted this document"))):2==a[2]&&t.push(i.get_version_comment(e,__("cancelled this document")));else{var n=frappe.meta.get_docfield(i.frm.doctype,a[0],i.frm.docname);if(n&&!n.hidden){var s=frappe.perm.get_field_display_status(n,null,i.frm.perm);"Read"!==s&&"Write"!==s||r.push(__("{0} from {1} to {2}",[__(n.label),(frappe.ellipsis(a[1],40)||'""').bold(),(frappe.ellipsis(a[2],40)||'""').bold()]))}}return r.length<3}),r.length&&t.push(i.get_version_comment(e,__("changed value of {0}",[r.join(", ")])))}if(a.row_changed&&a.row_changed.length){r=[];a.row_changed.every(function(e){return e[3].every(function(t){var a=i.frm.fields_dict[e[0]]&&frappe.meta.get_docfield(i.frm.fields_dict[e[0]].grid.doctype,t[0],i.frm.docname);if(a&&!a.hidden){var n=frappe.perm.get_field_display_status(a,null,i.frm.perm);"Read"!==n&&"Write"!==n||r.push(__("{0} from {1} to {2} in row #{3}",[frappe.meta.get_label(i.frm.fields_dict[e[0]].grid.doctype,t[0]),(frappe.ellipsis(t[1],40)||'""').bold(),(frappe.ellipsis(t[2],40)||'""').bold(),e[1]]))}return r.length<3}),r.length<3}),r.length&&t.push(i.get_version_comment(e,__("changed values for {0}",[r.join(", ")])))}["added","removed"].forEach(function(n){a[n]&&a[n].length&&(r=(r=(a[n]||[]).map(function(e){var t=frappe.meta.get_docfield(i.frm.doctype,e[0],i.frm.docname);if(t&&!t.hidden){var a=frappe.perm.get_field_display_status(t,null,i.frm.perm);if("Read"===a||"Write"===a)return frappe.meta.get_label(i.frm.doctype,e[0])}})).filter(function(e){return e})).length&&t.push(i.get_version_comment(e,__("{0} rows for {1}",[__(n),r.join(", ")])))})}}})}get_version_comment(e,t,i){return i||(t='<a href="#Form/Version/'+e.name+'">'+t+"</a>"),{comment_type:i||"Edit",creation:e.creation,owner:e.owner,version_name:e.name,sender:e.owner,comment_by:e.owner,content:t}}insert_comment(e,t,i){var a=this;return frappe.call({method:"frappe.desk.form.utils.add_comment",args:{doc:{doctype:"Communication",communication_type:"Comment",comment_type:e||"Comment",reference_doctype:this.frm.doctype,reference_name:this.frm.docname,content:t,sender:frappe.session.user}},btn:i,callback:function(e){if(!e.exc){a.comment_area.set_value(""),frappe.utils.play_sound("click");for(var t=e.message,i=a.get_communications(),r=!1,n=0,s=i.length;n<s;n++)if(i[n].name==t.name){r=!0;break}if(r)return;a.frm.get_docinfo().communications=i.concat([e.message]),a.refresh(!0)}}})}delete_comment(e){var t=this;frappe.confirm(__("Delete comment?"),function(){return frappe.call({method:"frappe.client.delete",args:{doctype:"Communication",name:e},callback:function(i){i.exc||(frappe.utils.play_sound("delete"),t.frm.get_docinfo().communications=$.map(t.frm.get_docinfo().communications,function(t){return t.name==e?null:t}),t.refresh(!0))}})})}update_comment(e,t){return frappe.call({method:"frappe.desk.form.utils.update_comment",args:{name:e,content:t},callback:function(e){e.exc||frappe.utils.play_sound("click")}})}get_recipient(){return this.frm.email_field?this.frm.doc[this.frm.email_field]:this.frm.doc.email_id||this.frm.doc.email||""}get_last_email(e){var t=null,i=this.frm.get_docinfo().communications,a=this.get_recipient();return $.each(i&&i.sort(function(e,t){return e.creation>t.creation?-1:1}),function(i,r){if("Communication"==r.communication_type&&"Email"==r.communication_medium){if(!e)return t=r,!1;if(-1!==r.sender.indexOf(a))return t=r,!1}}),t}get_names_for_mentions(){return Object.keys(frappe.boot.user_info).filter(function(e){return!["Administrator","Guest"].includes(e)}).map(function(e){return frappe.boot.user_info[e].name})}setup_comment_like(){this.wrapper.on("click",".comment-likes .octicon-heart",frappe.ui.click_toggle_like),frappe.ui.setup_like_popover(this.wrapper,".comment-likes")}},$.extend(frappe.timeline,{new_communication:function(e){var t=frappe.model.get_docinfo(e.reference_doctype,e.reference_name);if(t&&t.communications){for(var i=t.communications,a=!1,r=0,n=i.length;r<n;r++)if(i[r].name==e.name){a=!0;break}a||(t.communications=i.concat([e]))}cur_frm.doctype===e.reference_doctype&&cur_frm.docname===e.reference_name&&cur_frm.timeline&&cur_frm.timeline.refresh()},delete_communication:function(e){var t=frappe.model.get_docinfo(e.reference_doctype,e.reference_name),i=frappe.timeline.index_of_communication(e,t);-1!==i&&t.communications.splice(i,1),cur_frm.doctype===e.reference_doctype&&cur_frm.docname===e.reference_name&&cur_frm.timeline&&cur_frm.timeline.refresh()},update_communication:function(e){var t=frappe.model.get_docinfo(e.reference_doctype,e.reference_name),i=frappe.timeline.index_of_communication(e,t);-1!==i&&$.extend(t.communications[i],e),cur_frm.doctype===e.reference_doctype&&cur_frm.docname===e.reference_name&&cur_frm.timeline&&cur_frm.timeline.refresh()},index_of_communication:function(e,t){var i=-1;if(t&&t.communications)for(var a=t.communications,r=0,n=a.length;r<n;r++)if(a[r].name==e.name){i=r;break}return i}}),frappe.provide("frappe.ui.form"),frappe.ui.form.AssignTo=Class.extend({init:function(e){var t=this;$.extend(this,e),this.btn=this.parent.find(".add-assignment").on("click",function(){t.add()}),this.btn_wrapper=this.btn.parent(),this.refresh()},refresh:function(){this.frm.doc.__islocal?this.parent.toggle(!1):(this.parent.toggle(!0),this.render(this.frm.get_docinfo().assignments))},render:function(e){var t=this;if(this.frm.get_docinfo().assignments=e,this.parent.find(".assignment-row").remove(),t.primary_action&&(t.primary_action.remove(),t.primary_action=null),this.dialog&&this.dialog.hide(),e&&e.length){for(var i=0;i<e.length;i++){var a=frappe.user_info(e[i].owner);a.assign_to_name=e[i].name,a.owner=e[i].owner,a.avatar=frappe.avatar(e[i].owner),a.description=e[i].description||"",a._fullname=a.fullname,a.fullname.length>10&&(a._fullname=a.fullname.substr(0,10)+"..."),$(repl('<li class="assignment-row">\t\t\t\t\t<a class="close" data-owner="%(owner)s">&times;</a>\t\t\t\t\t%(avatar)s\t\t\t\t\t<span><a href="#Form/ToDo/%(assign_to_name)s">%(_fullname)s</a></span>\t\t\t\t</li>',a)).insertBefore(this.parent.find(".add-assignment")),e[i].owner===frappe.session.user&&(t.primary_action=this.frm.page.add_menu_item(__("Assignment Complete"),function(){t.remove(frappe.session.user)},"fa fa-check","btn-success")),e[i].owner===frappe.session.user||t.frm.perm[0].write||t.parent.find("a.close").remove()}this.parent.find("a.close").click(function(){return t.remove($(this).attr("data-owner")),!1})}},add:function(){var e=this;this.frm.is_new()?frappe.throw(__("Please save the document before assignment")):(e.assign_to||(e.assign_to=new frappe.ui.form.AssignToDialog({obj:e,method:"frappe.desk.form.assign_to.add",doctype:e.frm.doctype,docname:e.frm.docname,callback:function(t){e.render(t.message)}})),e.assign_to.dialog.clear(),e.frm.meta.title_field&&e.assign_to.dialog.set_value("description",e.frm.doc[e.frm.meta.title_field]),e.assign_to.dialog.show(),e.assign_to=null)},remove:function(e){var t=this;this.frm.is_new()?frappe.throw(__("Please save the document before removing assignment")):frappe.call({method:"frappe.desk.form.assign_to.remove",args:{doctype:t.frm.doctype,name:t.frm.docname,assign_to:e},callback:function(e,i){t.render(e.message)}})}}),frappe.ui.form.AssignToDialog=Class.extend({init:function(e){var t=this,i=new frappe.ui.Dialog({title:__("Add to To Do"),fields:[{fieldtype:"Link",fieldname:"assign_to",options:"User",label:__("Assign To"),reqd:!0,filters:{user_type:"System User"}},{fieldtype:"Check",fieldname:"myself",label:__("Assign to me"),default:0},{fieldtype:"Small Text",fieldname:"description",label:__("Comment")},{fieldtype:"Section Break"},{fieldtype:"Column Break"},{fieldtype:"Date",fieldname:"date",label:__("Complete By")},{fieldtype:"Check",fieldname:"notify",label:__("Notify by Email")},{fieldtype:"Column Break"},{fieldtype:"Select",fieldname:"priority",label:__("Priority"),options:[{value:"Low",label:__("Low")},{value:"Medium",label:__("Medium")},{value:"High",label:__("High")}],default:"Medium"}],primary_action:function(){frappe.ui.add_assignment(e,this)},primary_action_label:__("Add")});$.extend(t,i),t.dialog=i,t.dialog.fields_dict.assign_to.get_query="frappe.core.doctype.user.user.user_query";var a=t.dialog.get_input("myself").on("click",function(){t.toggle_myself(this)});t.toggle_myself(a)},toggle_myself:function(e){var t=this;$(e).prop("checked")?(t.dialog.set_value("assign_to",frappe.session.user),t.dialog.set_value("notify",0),t.dialog.get_field("notify").$wrapper.toggle(!1),t.dialog.get_field("assign_to").$wrapper.toggle(!1)):(t.dialog.set_value("assign_to",""),t.dialog.get_field("notify").$wrapper.toggle(!0),t.dialog.get_field("assign_to").$wrapper.toggle(!0))}}),frappe.ui.add_assignment=function(e,t){var i=t.fields_dict.assign_to.get_value(),a=t.get_values();if(a&&i)return frappe.call({method:e.method,args:$.extend(a,{doctype:e.doctype,name:e.docname,assign_to:i,bulk_assign:e.bulk_assign||!1,re_assign:e.re_assign||!1}),callback:function(i,a){i.exc||(e.callback&&e.callback(i),t&&t.hide())},btn:this})},frappe.provide("frappe.ui.form"),frappe.ui.form.make_quick_entry=function(e,t,i,a){var r=e.replace(/ /g,""),n="QuickEntryForm";return frappe.ui.form[r+"QuickEntryForm"]&&(n=r+"QuickEntryForm"),frappe.quick_entry=new frappe.ui.form[n](e,t,i,a),frappe.quick_entry.setup()},frappe.ui.form.QuickEntryForm=Class.extend({init:function(e,t,i,a){this.doctype=e,this.after_insert=t,this.init_callback=i,this.doc=a},setup:function(){var e=this,t=this;return new Promise(function(i){frappe.model.with_doctype(e.doctype,function(){t.set_meta_and_mandatory_fields(),t.is_quick_entry()?(t.render_dialog(),i(t)):(frappe.quick_entry=null,frappe.set_route("Form",t.doctype,t.doc.name).then(function(){return i(t)}))})})},set_meta_and_mandatory_fields:function(){var e=frappe.get_meta(this.doctype).fields;e.length<7?this.mandatory=e:this.mandatory=$.map(e,function(e){return(e.reqd||e.bold||e.allow_in_quick_entry)&&!e.read_only?$.extend({},e):null}),this.meta=frappe.get_meta(this.doctype),this.doc||(this.doc=frappe.model.get_new_doc(this.doctype,null,null,!0))},is_quick_entry:function(){return 1==this.meta.quick_entry&&(this.validate_for_prompt_autoname(),!(this.has_child_table()||!this.mandatory.length))},too_many_mandatory_fields:function(){return this.mandatory.length>7},has_child_table:function(){return!!$.map(this.mandatory,function(e){return"Table"===e.fieldtype?e:null}).length},validate_for_prompt_autoname:function(){this.meta.autoname&&"prompt"===this.meta.autoname.toLowerCase()&&(this.mandatory=[{fieldname:"__newname",label:__("{0} Name",[this.meta.name]),reqd:1,fieldtype:"Data"}].concat(this.mandatory))},render_dialog:function(){var e=this;this.dialog=new frappe.ui.Dialog({title:__("New {0}",[__(this.doctype)]),fields:this.mandatory}),this.dialog.doc=this.doc,this.register_primary_action(),this.render_edit_in_full_page_link(),this.dialog.wrapper.keydown(function(t){if((t.ctrlKey||t.metaKey)&&13==t.which&&!frappe.request.ajax_count)return e.dialog.get_primary_btn().trigger("click"),t.preventDefault(),!1}),this.dialog.onhide=function(){return frappe.quick_entry=null},this.dialog.show(),this.dialog.refresh_dependency(),this.set_defaults(),this.init_callback&&this.init_callback(this.dialog)},register_primary_action:function(){var e=this;this.dialog.set_primary_action(__("Save"),function(){e.dialog.working||e.dialog.get_values()&&(e.dialog.working=!0,e.dialog.set_message(__("Saving...")),e.insert().then(function(){e.dialog.clear_message()}))})},insert:function(){var e=this;return new Promise(function(t){e.update_doc(),frappe.call({method:"frappe.client.insert",args:{doc:e.dialog.doc},callback:function(t){e.dialog.hide(),frappe.model.clear_doc(e.dialog.doc.doctype,e.dialog.doc.name),e.dialog.doc=t.message,frappe._from_link?frappe.ui.form.update_calling_link(e.dialog.doc):e.after_insert?e.after_insert(e.dialog.doc):e.open_form_if_not_list()},error:function(){e.open_doc()},always:function(){e.dialog.working=!1,t(e.dialog.doc)},freeze:!0})})},open_form_if_not_list:function(){var e=frappe.get_route(),t=this.dialog.doc;!e||"List"===e[0]&&e[1]===t.doctype||frappe.run_serially([function(){return frappe.set_route("Form",t.doctype,t.name)}])},update_doc:function(){var e=this,t=this.dialog.get_values(!0);return $.each(t,function(t,i){"__newname"===t?e.dialog.doc.name=i:is_null(i)||(e.dialog.doc[t]=i)}),this.dialog.doc},open_doc:function(){this.dialog.hide(),this.update_doc(),frappe.set_route("Form",this.doctype,this.doc.name)},render_edit_in_full_page_link:function(){var e=this;$('<div style="padding-left: 7px; padding-top: 30px; padding-bottom: 10px;"><button class="edit-full btn-default btn-sm">'+__("Edit in full page")+"</button></div>").appendTo(this.dialog.body).find(".edit-full").on("click",function(){e.open_doc()})},set_defaults:function(){var e=this;$.each(this.dialog.fields_dict,function(t,i){i.doctype=e.doc.doctype,i.docname=e.doc.name,is_null(e.doc[t])||i.set_input(e.doc[t])})}}),frappe.provide("frappe.ui.form"),frappe.provide("frappe.success_action"),frappe.ui.form.SuccessAction=class{constructor(e){this.form=e,this.load_setting()}load_setting(){var e=this;this.setting=frappe.boot.success_action.find(function(t){return t.ref_doctype===e.form.doctype})}show(){this.setting&&(0!==this.form.doc.docstatus||this.form.is_first_creation())&&(this.prepare_dom(),this.show_alert())}prepare_dom(){this.container=$(document.body).find(".success-container"),this.container.length||(this.container=$('<div class="success-container">').appendTo(document.body))}show_alert(){var e=this;frappe.db.count(this.form.doctype).then(function(t){var i=e.setting,a=1===t?i.first_success_message:i.message,r=e.get_actions().map(function(t){var i=$('<button class="next-action"><span>'+t.label+"</span></button>");return i.click(function(){return t.action(e.form)}),i}),n=$('<div class="next-action-container"></div>');n.append(r);var s=n;frappe.show_alert({message:a,body:s,indicator:"green"},i.action_timeout)})}get_actions(){var e=this,t=[];return this.setting.next_actions.split("\n").forEach(function(i){"string"==typeof i&&e.default_actions[i]?t.push(e.default_actions[i]):"object"==typeof i&&t.push(i)}),t}get default_actions(){return{new:{label:__("New"),action:function(e){return frappe.new_doc(e.doctype)}},print:{label:__("Print"),action:function(e){return e.print_doc()}},email:{label:__("Email"),action:function(e){return e.email_doc()}},list:{label:__("View All"),action:function(e){frappe.set_route("List",e.doctype)}}}}}}();
//# sourceMappingURL=form.min.js.map
